{% extends "base.html" %}

{% block content %}
<h1 class="fs-4 fw-bold mb-4 ">Manage Virtual Machine</h1>

<!-- 外層表單保留，但不再設定 action，也不再放送出按鈕 -->
<form id="vm-management-form" class="mb-4">
  <!-- 不再需要 hidden action_type（已移除） -->

  <ul class="nav nav-tabs mb-4" id="actionTypeTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="create-tab" data-bs-toggle="tab" data-bs-target="#create-fields"
        type="button" role="tab">Create</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="update-tab" data-bs-toggle="tab" data-bs-target="#update-fields"
        type="button" role="tab">Update</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="delete-tab" data-bs-toggle="tab" data-bs-target="#delete-fields"
        type="button" role="tab">Delete</button>
    </li>
  </ul>

  <div class="tab-content" id="vm-tab-content">

    <!-- Create -->
    <div class="tab-pane fade show active" id="create-fields" role="tabpanel">
      <div class="card mb-3 border">
        <div class="card-body text-dark">
          <p>
            In this step, you can configure the environment settings for creating a new Virtual Machine (VM).
          </p>
          <p>
            After selecting the appropriate options, click <strong>Save to Draft</strong> to store your configuration as a draft.
          </p>
          <p>
            Once submitted from overview, the system will automatically create a Jira ticket and trigger the VM provisioning pipeline.
          </p>
        </div>
      </div>
      {% set action_type = 'Create' %}
      {% include "create/form.html" %}
    </div>

    <!-- Update -->
    <div class="tab-pane fade" id="update-fields" role="tabpanel">
      <div class="alert alert-warning">（請依需求填入更新欄位）</div>
      {% set action_type = 'Update' %}
      {% include "update/form.html" %}
    </div>

    <!-- Delete -->
    <div class="tab-pane fade" id="delete-fields" role="tabpanel">
      <div class="alert alert-danger">（請選擇要刪除的 VM 名稱）</div>
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">VM Name Prefix</label>
          <select name="vm_name_prefix" class="form-select" data-required="true">
            <option value="" disabled selected>--- Select ---</option>
            {% for vm_name in vm_name %}
            <option value="{{ vm_name }}">{{ vm_name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
    </div>

  </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const actionTabs = document.querySelectorAll('#actionTypeTabs button[data-bs-toggle="tab"]');

    // 只負責分頁切換時，啟用/停用欄位，與 required 標記
    function updateFormState(activePaneSelector) {
        // 先停用所有 pane 的所有 fields，並移除 required
        document.querySelectorAll('#vm-tab-content .tab-pane [name]').forEach(el => {
            el.disabled = true;
        });
        document.querySelectorAll('#vm-tab-content [data-required="true"]').forEach(el => {
            el.removeAttribute('required');
        });

        // 啟用目前 pane 的欄位，並加回 required
        const activePane = document.querySelector(activePaneSelector);
        if (activePane) {
            activePane.querySelectorAll('[name]').forEach(el => {
                el.disabled = false;
            });
            activePane.querySelectorAll('[data-required="true"]').forEach(el => {
                el.setAttribute('required', '');
            });
        }
    }

    // 監聽分頁切換
    actionTabs.forEach(tab => {
        tab.addEventListener('shown.bs.tab', event => {
            const targetPaneSelector = event.target.getAttribute('data-bs-target');
            updateFormState(targetPaneSelector);
        });
    });

    // 初始狀態：顯示 Create pane 並套用 required
    const initialTab = document.getElementById('create-tab');
    if (initialTab) {
        const tab = new bootstrap.Tab(initialTab);
        tab.show();

        const initialPaneSelector = initialTab.getAttribute('data-bs-target');
        updateFormState(initialPaneSelector);
    }
});
</script>

{% endblock %}