{% extends "base.html" %}

{% block content %}

<form method="post" action="{{ url_for('vm.vsphere_submit_request') }}" onsubmit="return confirm('Are you sure you want to submit this VM UPDATE request?');">
  <h2 class="fw-bold fs-3 mb-4">Review VM Update</h2>
  <p class="text-primary fw-bold">Current Action: {{ data.new_config.action_type }} {{ data.new_config.resource }}</p>
  <p class="text-primary fw-bold">
      Updating VM: <strong>{{ data.new_config.vm_name_prefix }}</strong> in <strong>{{ data.new_config.environment }}</strong> environment
  </p>

  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-light text-dark fw-bold">Configuration Changes</div>
    <div class="card-body">
        <table class="table table-bordered align-middle">
            <thead class="table-light">
                <tr>
                    <th style="width: 25%;">Field</th>
                    <th style="width: 37.5%;">Original Value</th>
                    <th style="width: 37.5%;">New Value</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>vCPU</strong></td>
                    <td>{{ data.original_config.vm_num_cpus }}</td>
                    <td>
                        {% if data.original_config.vm_num_cpus|string != data.new_config.vm_num_cpus %}
                            <span class="text-danger fw-bold">{{ data.new_config.vm_num_cpus }} <i class="bi bi-arrow-left-right"></i></span>
                        {% else %}
                            {{ data.new_config.vm_num_cpus }}
                        {% endif %}
                    </td>
                </tr>

                <tr>
                    <td><strong>Memory (MB)</strong></td>
                    <td>{{ data.original_config.vm_memory }}</td>
                    <td>
                        {% if data.original_config.vm_memory|string != data.new_config.vm_memory %}
                            <span class="text-danger fw-bold">{{ data.new_config.vm_memory }} <i class="bi bi-arrow-left-right"></i></span>
                        {% else %}
                            {{ data.new_config.vm_memory }}
                        {% endif %}
                    </td>
                </tr>

                <tr>
                    <td><strong>Additional Disks</strong></td>

                    {# -------------------- Original Value（以 DB 為準，不顯示 SCSI） -------------------- #}
                    <td>
                        {% set original_disks = data.original_config.additional_disks or [] %}
                        {% if original_disks and original_disks|length > 0 %}
                            {% for d in original_disks %}
                                {% set label_txt = ('Hard Disk ' ~ d.ui_disk_number) if d.ui_disk_number is not none else (d.label or 'Hard Disk') %}
                                {% set prov_txt  = (d.disk_provisioning or 'thin')|replace('_',' ')|title %}
                                <div class="mb-1">
                                    <span class="badge bg-secondary">
                                        {{ label_txt }}: {{ d.size }} GB, {{ prov_txt }}
                                    </span>
                                </div>
                            {% endfor %}
                        {% else %}
                            <span class="text-muted">No additional disks</span>
                        {% endif %}
                    </td>

                    {# -------------------- New Value（依表單 session 值顯示） -------------------- #}
                    <td>
                        {# 此處的邏輯可能需要根據您 update form 的最終設計來調整 #}
                        <span class="text-info">Changes will be processed upon approval.</span>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
  </div>

  <div class="d-flex justify-content-end mt-4">
    <a href="{{ url_for('vm.vsphere_cancel_vm_form') }}" class="btn btn-outline-danger me-2">Cancel</a>
    <a href="{{ url_for('vm.vm_index', active_tab='update') }}" class="btn btn-outline-secondary me-2">Previous</a>
    <button type="submit" class="btn btn-primary px-5">Confirm & Submit Update</button>
  </div>
</form>

{% endblock %}