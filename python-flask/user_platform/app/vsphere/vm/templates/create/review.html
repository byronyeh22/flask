{% extends "base.html" %}

{% block content %}

<form method="post" action="{{ url_for('vm.vsphere_submit_request') }}" onsubmit="return confirmSubmit();">
  <h2 class="fw-bold fs-3 mb-4">Review Request</h2>
  <p class="text-primary fw-bold">
    Current Action: {{ data.action_type | capitalize }} {{ data.resource | default('VM') | capitalize }}
  </p>

  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-light text-dark fw-bold">vSphere Configuration</div>
    <div class="card-body">
      <ul class="list-group list-group-flush">
        <li class="list-group-item"><strong>Environment:</strong> <span>{{ data.environment }}</span></li>
        <li class="list-group-item"><strong>Datacenter:</strong> <span>{{ data.vsphere_datacenter }}</span></li>
        <li class="list-group-item"><strong>Cluster:</strong> <span>{{ data.vsphere_cluster }}</span></li>
        <li class="list-group-item"><strong>VM Template:</strong> <span>{{ data.vsphere_template }}</span></li>
        <li class="list-group-item"><strong>Datastore:</strong> <span>{{ data.vsphere_datastore }}</span></li>
        <li class="list-group-item"><strong>Network:</strong> <span>{{ data.vsphere_network }}</span></li>
        <li class="list-group-item"><strong>IPv4 Gateway:</strong> <span>{{ data.vm_ipv4_gateway }}</span></li>
      </ul>
    </div>
  </div>

  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-light text-dark fw-bold">VM Configuration</div>
    <div class="card-body">
      <ul class="list-group list-group-flush">
        <li class="list-group-item"><strong>VM Name Prefix:</strong> <span>{{ data.vm_name_prefix }}</span></li>
        <li class="list-group-item"><strong>OS Type:</strong> <span>{{ data.os_type }}</span></li>
        <li class="list-group-item"><strong>VM Instance Type:</strong> <span>{{ data.vm_instance_type }}</span></li>
        <li class="list-group-item"><strong>vCPU:</strong> <span>{{ data.vm_num_cpus }}</span></li>
        <li class="list-group-item"><strong>Memory (MB):</strong> <span>{{ data.vm_memory }}</span></li>

        <li class="list-group-item">
          <strong>Additional Hard Disks:</strong>
          {# 註解: 確保從 session/form_data 傳來的陣列可以被正確處理 #}
          {% set sizes = data['create_vm_disk_size[]'] if data['create_vm_disk_size[]'] is sequence else [data['create_vm_disk_size[]']] if data['create_vm_disk_size[]'] else [] %}
          {% set provs = data['create_vm_disk_provisioning[]'] if data['create_vm_disk_provisioning[]'] is sequence else [data['create_vm_disk_provisioning[]']] if data['create_vm_disk_provisioning[]'] else [] %}

          {% if sizes and sizes|length > 0 %}
            <div class="table-responsive mt-2">
              <table class="table table-sm table-bordered align-middle">
                <thead class="table-light">
                  <tr>
                    <th style="width: 33%;">Disk Label</th>
                    <th style="width: 20%;">Size (GB)</th>
                    <th style="width: 47%;">Provisioning</th>
                  </tr>
                </thead>
                <tbody>
                {% for i in range(sizes|length) %}
                  {% set sz = sizes[i] %}
                  {% set prov = (provs[i] if i < provs|length else 'thin') %}
                  {% set prov_display = 'Thin Provision' if prov == 'thin'
                                        else 'Thick Provision Lazy Zeroed' if prov == 'thick_lazy'
                                        else 'Thick Provision Eager Zeroed' %}
                  <tr>
                    <td>
                      <span class="badge bg-secondary">New Disk {{ i + 1 }}</span>
                    </td>
                    <td>{{ sz }}</td>
                    <td>{{ prov_display }}</td>
                  </tr>
                {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p class="text-muted mt-2 mb-0">No additional disks requested.</p>
          {% endif %}
        </li>
      </ul>
    </div>
  </div>

  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-light text-dark fw-bold">NetBox Configuration</div>
    <div class="card-body">
      <ul class="list-group list-group-flush">
        <li class="list-group-item"><strong>NetBox Prefix:</strong> <span>{{ data.netbox_prefix }}</span></li>
        <li class="list-group-item"><strong>NetBox Tenant:</strong> <span>{{ data.netbox_tenant }}</span></li>
      </ul>
    </div>
  </div>

  <div class="d-flex justify-content-end mt-4">
    <a href="{{ url_for('vm.vsphere_cancel_vm_form') }}" class="btn btn-outline-danger me-2">Cancel</a>
    <a href="{{ url_for('vm.vm_index') }}" class="btn btn-outline-secondary me-2">Previous</a>
    <button type="submit" class="btn btn-primary px-5">Confirm & Submit Request</button>
  </div>
</form>

<script>
  function confirmSubmit() {
    return confirm("Are you sure you want to submit this VM request for approval?");
  }
</script>

{% endblock %}