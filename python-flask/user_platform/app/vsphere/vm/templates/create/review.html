<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Review Request</title>
  <!-- 保留原本 CSS 體感：載入 Bootstrap 與 Icons（不再 extends base.html，因此自行引入） -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    .kv { display: grid; grid-template-columns: 220px 1fr; gap: .5rem 1rem; }
    .kv .k { color: #6c757d; font-weight: 600; }
    .kv .v { word-break: break-word; }
    .table-disks th, .table-disks td { vertical-align: middle; }
  </style>
</head>
<body>
<div class="container-fluid py-3">

  <h4 class="mb-3">Review Request</h4>

  {# 後端以 render_template("create/review.html", data=...) 傳入 data #}
  {% set d = data or {} %}

  {# 磁碟欄位陣列處理：兩者皆可能為單值或陣列 #}
  {% set sizes = d.get('create_vm_disk_size[]', []) %}
  {% set provs = d.get('create_vm_disk_provisioning[]', []) %}
  {% if sizes is string %}{% set sizes = [sizes] %}{% endif %}
  {% if provs is string %}{% set provs = [provs] %}{% endif %}

  <!-- Summary -->
  <div class="card shadow-sm mb-3">
    <div class="card-header bg-light fw-bold">Summary</div>
    <div class="card-body">
      <div class="kv">
        <div class="k">Action</div><div class="v">{{ d.get('action_type', 'Create') }}</div>
        <div class="k">Resource</div><div class="v">{{ d.get('resource', 'vm') }}</div>
        <div class="k">Environment</div><div class="v">{{ d.get('environment','-') }}</div>
        <div class="k">VM Name Prefix</div><div class="v">{{ d.get('vm_name_prefix','-') }}</div>
      </div>
    </div>
  </div>

  <div class="row g-3">
    <!-- Core -->
    <div class="col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-light fw-bold">Core</div>
        <div class="card-body">
          <div class="kv">
            <div class="k">OS Type</div><div class="v">{{ d.get('os_type','-') }}</div>
            <div class="k">Instance Type</div><div class="v">{{ d.get('vm_instance_type','-') }}</div>
            <div class="k">vCPU</div><div class="v">{{ d.get('vm_num_cpus','-') }}</div>
            <div class="k">Memory (MB)</div><div class="v">{{ d.get('vm_memory','-') }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- vSphere Placement -->
    <div class="col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-light fw-bold">vSphere Placement</div>
        <div class="card-body">
          <div class="kv">
            <div class="k">Datacenter</div><div class="v">{{ d.get('vsphere_datacenter','-') }}</div>
            <div class="k">Cluster</div><div class="v">{{ d.get('vsphere_cluster','-') }}</div>
            <div class="k">Template</div><div class="v">{{ d.get('vsphere_template','-') }}</div>
            <div class="k">Datastore</div><div class="v">{{ d.get('vsphere_datastore','-') }}</div>
            <div class="k">Network</div><div class="v">{{ d.get('vsphere_network','-') }}</div>
            <div class="k">IPv4 Gateway</div><div class="v">{{ d.get('vm_ipv4_gateway','-') }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- NetBox -->
  <div class="card shadow-sm mt-3">
    <div class="card-header bg-light fw-bold">NetBox</div>
    <div class="card-body">
      <div class="kv">
        <div class="k">Prefix</div><div class="v">{{ d.get('netbox_prefix','-') }}</div>
        <div class="k">Tenant</div><div class="v">{{ d.get('netbox_tenant','-') }}</div>
      </div>
    </div>
  </div>

  <!-- Additional Disks -->
  <div class="card shadow-sm mt-3">
    <div class="card-header bg-light fw-bold">Additional Disks</div>
    <div class="card-body">
      {% if sizes and sizes|length > 0 %}
        <div class="table-responsive">
          <table class="table table-sm table-bordered table-disks mb-0">
            <thead class="table-light">
              <tr><th>#</th><th>Size (GB)</th><th>Provisioning</th></tr>
            </thead>
            <tbody>
              {% for i in range(sizes|length) %}
                <tr>
                  <td>{{ i + 1 }}</td>
                  <td>{{ sizes[i] }}</td>
                  <td>{{ (provs[i] if i < provs|length else 'thin') }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <span>-</span>
      {% endif %}
    </div>
  </div>

  <!-- 還原：Confirm & Submit 按鈕 -->
  <!-- 現階段沿用你原本的 /vsphere/vm/submit。若你改為從 DRAFT 送審的後端路由，之後再把 action 改掉即可。 -->
  <div class="mt-4 d-flex justify-content-end gap-2">
    <form method="post" action="{{ url_for('vm.vsphere_submit_request') }}?from_modal=1" onsubmit="return confirm('Are you sure you want to submit this VM creation request?');">
      <input type="hidden" name="workflow_id" value="{{ workflow.workflow_id }}">
      <button type="submit" class="btn btn-primary">
        <i class="bi bi-check2-circle me-1"></i> Confirm &amp; Submit
      </button>
    </form>
  </div>

</div>

<!-- Bootstrap 5 JS (for modal behaviors etc. if needed inside iframe) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>