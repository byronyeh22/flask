{% if action_type %}
  <div class="alert alert-info fw-bold mb-3">
    Current Action: {{ action_type }}
  </div>
{% endif %}

<input type="hidden" name="resource" value="vm">
<input type="hidden" name="action_type" value="create">
<!-- 自動維護的 SCSI controller 數量（= 最大 scsi_controller + 1，至少 1） -->
<input type="hidden" id="create_vm_scsi_controller_count" name="create_vm_scsi_controller_count" value="1">

<style>
  .btn-remove {
    background-color: #dc3545; /* Bootstrap danger 紅色 */
    color: white;
  }
  .btn-remove:hover {
    background-color: #c82333;
    color: white;
  }
  .btn-add {
    background-color: #28a745; /* Bootstrap success 綠色 */
    color: white;
  }
  .btn-add:hover {
    background-color: #218838;
    color: white;
  }
</style>

<div class="card mb-4 shadow-sm">
  <div class="card-header mb-3 bg-success text-white fw-bold">Configure VM Detail</div>
  <div class="card-body">
    <div class="row g-3">

      <div class="row mb-3 align-items-center">
        <label class="col-md-3 col-form-label text-end">Environment</label>
        <div class="col-md-6">
          <select name="environment" class="form-select" data-required="true">
            <option value="" disabled {% if not session.create_vm_form_data or not session.create_vm_form_data.environment %}selected{% endif %}>--- Select ---</option>
            <option value="sandbox" {% if session.create_vm_form_data and session.create_vm_form_data.environment == 'sandbox' %}selected{% endif %}>SanBox</option>
            <option value="qat" {% if session.create_vm_form_data and session.create_vm_form_data.environment == 'qat' %}selected{% endif %}>QAT</option>
            <option value="uat" {% if session.create_vm_form_data and session.create_vm_form_data.environment == 'uat' %}selected{% endif %}>UAT</option>
          </select>
        </div>
      </div>

      <div class="row mb-3 align-items-center">
        <label class="col-md-3 col-form-label text-end">VM Name Prefix</label>
        <div class="col-md-6">
          <input
            type="text"
            name="vm_name_prefix"
            class="form-control"
            data-required="true"
            value="{{ session.create_vm_form_data.vm_name_prefix if session.create_vm_form_data and 'vm_name_prefix' in session.create_vm_form_data else '' }}"
          >
        </div>
      </div>

      <div class="row mb-3 align-items-center">
        <label class="col-md-3 col-form-label text-end">OS Type</label>
        <div class="col-md-6">
          <div class="form-check form-check-inline">
            <input
              class="form-check-input"
              type="radio"
              name="os_type"
              id="os_windows"
              value="windows"
              data-required="true"
              {% if session.create_vm_form_data and session.create_vm_form_data.os_type == 'windows' %}checked{% endif %}
            >
            <label for="os_windows">
              <i class="bi bi-windows"></i> Windows
            </label>
          </div>
          <div class="form-check form-check-inline">
            <input
              class="form-check-input"
              type="radio"
              name="os_type"
              id="os_linux"
              value="linux"
              data-required="true"
              {% if session.create_vm_form_data and session.create_vm_form_data.os_type == 'linux' %}checked{% endif %}
            >
            <label for="os_linux">
              <i class="bi bi-linux"></i> Linux
            </label>
          </div>
        </div>
      </div>

      <div class="row mb-3 align-items-center">
        <label class="col-md-3 col-form-label text-end">VM Instance Type</label>
        <div class="col-md-6">
          <div class="form-check form-check-inline">
            <input
              class="form-check-input"
              type="radio"
              name="vm_instance_type"
              id="type_Generic"
              value="Generic"
              data-required="true"
              {% if session.create_vm_form_data and session.create_vm_form_data.vm_instance_type == 'Generic' %}checked{% endif %}
            >
            <label class="form-check-label" for="type_Generic">
              Generic
              <i class="bi bi-exclamation-circle-fill text-secondary ms-1"
                 data-bs-toggle="tooltip"
                 data-bs-placement="right"
                 data-bs-html="true"
                 title="Defatul Installation：<br>OShardening<br>Tenable<br>MDE_Win<br>EPMAgent<br>SERVER-HARDENING<br>zabbix"
                 style="cursor: pointer;"></i>
            </label>
          </div>
          <div class="form-check form-check-inline">
            <input
              class="form-check-input"
              type="radio"
              name="vm_instance_type"
              id="type_Cleanroom"
              value="Cleanroom"
              data-required="true"
              {% if session.create_vm_form_data and session.create_vm_form_data.vm_instance_type == 'Cleanroom' %}checked{% endif %}
            >
            <label class="form-check-label" for="type_Cleanroom">
              Cleanroom
              <i class="bi bi-exclamation-circle-fill text-secondary ms-1"
                 data-bs-toggle="tooltip"
                 data-bs-placement="right"
                 data-bs-html="true"
                 title="Defatul Installation：<br>OShardening<br>EkranSystemClient<br>Tenable<br>MDE_Win<br>RSASecurity<br>EPMAgent<br>SERVER-HARDENING<br>zabbix"
                 style="cursor: pointer;"></i>
            </label>
          </div>
        </div>
      </div>

      <div class="row mb-3 align-items-center">
        <label class="col-md-3 col-form-label text-end">vCPU</label>
        <div class="col-md-6">
          <input
            type="number"
            name="vm_num_cpus"
            class="form-control"
            min="1"
            data-required="true"
            value="{{ session.create_vm_form_data.vm_num_cpus if session.create_vm_form_data and 'vm_num_cpus' in session.create_vm_form_data else '2' }}"
          >
        </div>
      </div>

      <div class="row mb-3 align-items-center">
        <label class="col-md-3 col-form-label text-end">Memory (MB)</label>
        <div class="col-md-6">
          <input
            type="number"
            name="vm_memory"
            class="form-control"
            min="512"
            step="256"
            data-required="true"
            value="{{ session.create_vm_form_data.vm_memory if session.create_vm_form_data and 'vm_memory' in session.create_vm_form_data else '2048' }}"
          >
        </div>
      </div>

      <!-- 這裡改用 create_vm_disk_size 的長度 -->
      <input type="hidden" id="disk-count" value="{{ session.create_vm_form_data.create_vm_disk_size|length if session.create_vm_form_data and 'create_vm_disk_size' in session.create_vm_form_data else 1 }}">

      <div class="row mb-3 align-items-start">
        <label class="col-md-3 col-form-label text-end">Additional Hard Disk</label>
        <div class="col-md-6">
          <div id="disk-container">
            {% if session.create_vm_form_data and 'create_vm_disk_size' in session.create_vm_form_data %}
              {% for i in range(0, session.create_vm_form_data.create_vm_disk_size|length) %}
              <div class="disk-item mb-2 p-3 border rounded bg-light">
                <div class="row align-items-end g-2">
                  <div class="col-md-3">
                    <label class="form-label mb-0">
                      Hard Disk Label
                      <i class="bi bi-info-circle ms-1 text-secondary scsi-tip"
                         data-bs-toggle="tooltip" data-bs-placement="top"
                         title="scsi(0:1)"></i>
                    </label>
                    <input type="text" class="form-control disk-label" value="Hard Disk {{ i + 2 }}" readonly>
                    <!-- 這兩個 hidden 是關鍵：JS 會把 controller/unit 填回來 -->
                    <input type="hidden" name="create_vm_disk_scsi_controller[]">
                    <input type="hidden" name="create_vm_disk_unit_number[]">
                  </div>

                  <div class="col-md-2">
                    <label class="form-label mb-0">Size (GB)</label>
                    <input
                      type="number"
                      name="create_vm_disk_size[]"
                      class="form-control"
                      min="1"
                      value="{{ session.create_vm_form_data.create_vm_disk_size[i] }}"
                      data-required="true">
                  </div>

                  <div class="col-md-5">
                    <label class="form-label mb-0">Disk Provisioning</label>
                    <select name="create_vm_disk_provisioning[]" class="form-select disk-provisioning" onchange="updateProvisioningValues(this)">
                      <option value="thin" {{ 'selected' if session.create_vm_form_data and 'create_vm_disk_provisioning' in session.create_vm_form_data and session.create_vm_form_data.create_vm_disk_provisioning|length > i and session.create_vm_form_data.create_vm_disk_provisioning[i] == 'thin' else '' }}>Thin Provision</option>
                      <option value="thick_lazy" {{ 'selected' if session.create_vm_form_data and 'create_vm_disk_provisioning' in session.create_vm_form_data and session.create_vm_form_data.create_vm_disk_provisioning|length > i and session.create_vm_form_data.create_vm_disk_provisioning[i] == 'thick_lazy' else '' }}>Thick Provision Lazy Zeroed</option>
                      <option value="thick_eager" {{ 'selected' if session.create_vm_form_data and 'create_vm_disk_provisioning' in session.create_vm_form_data and session.create_vm_form_data.create_vm_disk_provisioning|length > i and session.create_vm_form_data.create_vm_disk_provisioning[i] == 'thick_eager' else '' }}>Thick Provision Eager Zeroed</option>
                    </select>
                    <input type="hidden" name="create_vm_disk_thin_provisioned[]" class="thin-provisioned-value" value="{{ session.create_vm_form_data.create_vm_disk_thin_provisioned[i] if session.create_vm_form_data and 'create_vm_disk_thin_provisioned' in session.create_vm_form_data and session.create_vm_form_data.create_vm_disk_thin_provisioned|length > i else 'true' }}">
                    <input type="hidden" name="create_vm_disk_eagerly_scrub[]" class="eagerly-scrub-value" value="{{ session.create_vm_form_data.create_vm_disk_eagerly_scrub[i] if session.create_vm_form_data and 'create_vm_disk_eagerly_scrub' in session.create_vm_form_data and session.create_vm_form_data.create_vm_disk_eagerly_scrub|length > i else 'false' }}">
                  </div>

                  <div class="col-md-2 d-flex align-items-center">
                    <button type="button" class="btn btn-sm btn-remove remove-disk-btn" onclick="removeDisk(this)">
                      <i class="bi bi-trash"></i> Remove
                    </button>
                  </div>
                </div>
              </div>
              {% endfor %}
            {% endif %}
          </div>

          <div id="scsi-capacity-alert" class="alert alert-danger py-2 px-3 mb-2 d-none" role="alert">
            Reached maximum additional disks capacity (SCSI controllers 0–3). Remove a disk to add a new one.
          </div>

          <div class="alert alert-warning d-flex align-items-center py-2 px-3 mb-2" role="alert">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="me-2 flex-shrink-0" viewBox="0 0 16 16" role="img" aria-label="Warning:">
              <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.708c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
            </svg>
            NOTE: Hard Disk 1 uses the disk configuration from the template.
          </div>

          <button id="btn-add-disk" type="button" class="btn btn-sm btn-add" onclick="addDisk()">
            <i class="bi bi-plus-circle"></i> Add Disk
          </button>
        </div>
      </div>

      <hr class="my-1 mb-3 border-t border-[#dee2e6]">

      <div class="row mb-3 align-items-center">
        <label class="col-md-3 col-form-label text-end">Datacenter</label>
        <div class="col-md-6">
          <select name="vsphere_datacenter" class="form-select" data-required="true">
            <option value="" disabled {% if not session.create_vm_form_data or not session.create_vm_form_data.vsphere_datacenter %}selected{% endif %}>--- Select ---</option>
            {% for dc in datacenters %}
              <option value="{{ dc }}" {% if session.create_vm_form_data and session.create_vm_form_data.vsphere_datacenter == dc %}selected{% endif %}>{{ dc }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div class="row mb-3 align-items-center">
        <label class="col-md-3 col-form-label text-end">Cluster</label>
        <div class="col-md-6">
          <select name="vsphere_cluster" class="form-select" data-required="true">
            <option value="" disabled {% if not session.create_vm_form_data or not session.create_vm_form_data.vsphere_cluster %}selected{% endif %}>--- Select ---</option>
            {% for cluster in clusters %}
              <option value="{{ cluster }}" {% if session.create_vm_form_data and session.create_vm_form_data.vsphere_cluster == cluster %}selected{% endif %}>{{ cluster }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div class="row mb-3 align-items-center">
        <label class="col-md-3 col-form-label text-end">VM Template</label>
        <div class="col-md-6">
          <select name="vsphere_template" class="form-select" data-required="true">
            <option value="" disabled {% if not session.create_vm_form_data or not session.create_vm_form_data.vsphere_template %}selected{% endif %}>--- Select ---</option>
            {% for template in templates %}
              <option value="{{ template }}" {% if session.create_vm_form_data and session.create_vm_form_data.vsphere_template == template %}selected{% endif %}>{{ template }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div class="row mb-3 align-items-center">
        <label class="col-md-3 col-form-label text-end">Datastore</label>
        <div class="col-md-6">
          <select name="vsphere_datastore" class="form-select" data-required="true">
            <option value="" disabled {% if not session.create_vm_form_data or not session.create_vm_form_data.vsphere_datastore %}selected{% endif %}>--- Select ---</option>
            {% for ds in datastores %}
              <option value="{{ ds }}" {% if session.create_vm_form_data and session.create_vm_form_data.vsphere_datastore == ds %}selected{% endif %}>{{ ds }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <hr class="my-1 mb-3 border-t border-[#dee2e6]">

      <div class="row mb-3 align-items-center">
        <label class="col-md-3 col-form-label text-end">Network</label>
        <div class="col-md-6">
          <select name="vsphere_network" class="form-select" data-required="true">
            <option value="" disabled {% if not session.create_vm_form_data or not session.create_vm_form_data.vsphere_network %}selected{% endif %}>--- Select ---</option>
            {% for net in networks %}
              <option value="{{ net }}" {% if session.create_vm_form_data and session.create_vm_form_data.vsphere_network == net %}selected{% endif %}>{{ net }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div class="row mb-3 align-items-center">
        <label class="col-md-3 col-form-label text-end">IPv4 Gateway</label>
        <div class="col-md-6">
          <select name="vm_ipv4_gateway" class="form-select" data-required="true">
            <option value="" disabled {% if not session.create_vm_form_data or not session.create_vm_form_data.vm_ipv4_gateway %}selected{% endif %}>--- Select ---</option>
            <option value="172.26.1.1" {% if session.create_vm_form_data and session.create_vm_form_data.vm_ipv4_gateway == '172.26.1.1' %}selected{% endif %}>172.26.1.1</option>
            <option value="192.168.0.1" {% if session.create_vm_form_data and session.create_vm_form_data.vm_ipv4_gateway == '192.168.0.1' %}selected{% endif %}>192.168.0.1</option>
          </select>
        </div>
      </div>

    </div>
  </div>
</div>

<div class="card mb-4 shadow-sm">
  <div class="card-header mb-3 bg-success text-white fw-bold">NetBox Settings</div>
  <div class="card-body">
    <div class="row g-3">

      <div class="row mb-3 align-items-center">
        <label class="col-md-3 col-form-label text-end">NetBox Prefix</label>
        <div class="col-md-6">
          <select name="netbox_prefix" class="form-select" data-required="true">
            <option value="" disabled {% if not session.create_vm_form_data or not session.create_vm_form_data.netbox_prefix %}selected{% endif %}>--- Select ---</option>
            <option value="172.26.1.0/24" {% if session.create_vm_form_data and session.create_vm_form_data.netbox_prefix == '172.26.1.0/24' %}selected{% endif %}>172.26.1.0/24</option>
            <option value="192.168.0.0/24" {% if session.create_vm_form_data and session.create_vm_form_data.netbox_prefix == '192.168.0.0/24' %}selected{% endif %}>192.168.0.0/24</option>
          </select>
        </div>
      </div>

      <div class="row mb-3 align-items-center">
        <label class="col-md-3 col-form-label text-end">NetBox Tenant</label>
        <div class="col-md-6">
          <select name="netbox_tenant" class="form-select" data-required="true">
            <option value="" disabled {% if not session.create_vm_form_data or not session.create_vm_form_data.netbox_tenant %}selected{% endif %}>--- Select ---</option>
            <option value="RCBC-34" {% if session.create_vm_form_data and session.create_vm_form_data.netbox_tenant == 'RCBC-34' %}selected{% endif %}>RCBC-34</option>
          </select>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
  // === Bootstrap Tooltip 啟用 ===
  document.addEventListener('DOMContentLoaded', function() {
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    [...tooltipTriggerList].forEach(el => bootstrap.Tooltip.getOrCreateInstance(el));
    // 初始化第一次的 SCSI 重排
    reassignScsiSlots();
  });

  // vSphere 規則常數
  const MAX_SCSI_CONTROLLER = 3; // 允許 0..3 共 4 個控制器
  const VALID_UNITS = [0,1,2,3,4,5,6,8,9,10,11,12,13,14,15]; // 跳過 7
  const SYSTEM = { controller: 0, unit: 0 }; // 系統碟 scsi(0:0)
  // 總可新增容量：bus0(排除0與7=14) + bus1..3(15*3) = 59 顆額外碟
  const TOTAL_ADDITIONAL_CAPACITY = 59;

  function provisioningToFlags(v) {
    if (v === 'thin')       return { thin: 'true',  eager: 'false' };
    if (v === 'thick_lazy') return { thin: 'false', eager: 'false' };
    return { thin: 'false', eager: 'true' }; // thick_eager
  }

  function currentAdditionalCount() {
    return document.querySelectorAll('#disk-container .disk-item').length;
  }

  function setCapacityState(blocked) {
    const alertEl = document.getElementById('scsi-capacity-alert');
    const addBtn  = document.getElementById('btn-add-disk');
    if (alertEl) {
      alertEl.classList.toggle('d-none', !blocked);
    }
    if (addBtn) {
      addBtn.disabled = !!blocked;
    }
  }

  function reassignScsiSlots() {
    const diskContainer = document.getElementById('disk-container');
    const scsiCountHdn = document.getElementById('create_vm_scsi_controller_count');
    const rows = Array.from(diskContainer.querySelectorAll('.disk-item'));

    let controller = 0;
    let idx = 0;

    // 第一顆要避開系統碟的 unit=0（只在 controller=0 的第一顆額外碟要跳過）
    if (VALID_UNITS[idx] === SYSTEM.unit) idx++;

    let blocked = false;

    rows.forEach((row, i) => {
      // 若當前 controller 的單位用完，就換下一個 controller
      if (idx >= VALID_UNITS.length) {
        controller += 1;
        idx = 0;
      }

      // 控制器超出 3，代表超出可用容量：標示阻擋，其後的 row 不再指派
      if (controller > MAX_SCSI_CONTROLLER) {
        blocked = true;
        return;
      }

      let unit = VALID_UNITS[idx];

      // 只有第一個 controller 的第一顆額外碟需要跳過 unit 0（系統碟）
      if (i === 0 && controller === 0 && unit === SYSTEM.unit) {
        idx++;
        unit = VALID_UNITS[idx];
      }

      // 更新 tooltip 與 hidden 值
      const tipIcon = row.querySelector('.scsi-tip');
      if (tipIcon) {
        tipIcon.setAttribute('title', `scsi(${controller}:${unit})`);
        // 重新啟用 / 取得 tooltip（避免重複實例）
        const t = bootstrap.Tooltip.getOrCreateInstance(tipIcon);
        t.setContent({ '.tooltip-inner': `scsi(${controller}:${unit})` });
      }

      // 隱藏欄位：scsi_controller / unit_number
      const ctrlInput = row.querySelector('input[name="create_vm_disk_scsi_controller[]"]');
      const unitInput = row.querySelector('input[name="create_vm_disk_unit_number[]"]');
      if (ctrlInput) ctrlInput.value = String(controller);
      if (unitInput) unitInput.value = String(unit);

      // Label 重新連號（Hard Disk 2 起跳）
      const labelInput = row.querySelector('.disk-label');
      if (labelInput) labelInput.value = `Hard Disk ${i + 2}`;

      idx++;
    });

    // 更新 controller_count = 最大 controller + 1（至少 1，最多 4）
    const busVals = rows
      .map(r => parseInt(r.querySelector('input[name="create_vm_disk_scsi_controller[]"]')?.value ?? '0', 10))
      .filter(n => !Number.isNaN(n));
    const maxController = busVals.length ? Math.max(...busVals) : 0;
    const controllerCount = Math.max(1, Math.min(maxController + 1, MAX_SCSI_CONTROLLER + 1));
    if (scsiCountHdn) scsiCountHdn.value = String(controllerCount);

    // 容量上限保護：達到 59 顆或控制器溢出就鎖 Add
    setCapacityState(blocked || currentAdditionalCount() >= TOTAL_ADDITIONAL_CAPACITY);
  }

  function addDisk() {
    // 容量上限保護（59 顆額外碟）
    if (currentAdditionalCount() >= TOTAL_ADDITIONAL_CAPACITY) {
      setCapacityState(true);
      return;
    }

    const diskContainer = document.getElementById('disk-container');

    const row = document.createElement('div');
    row.className = 'disk-item mb-2 p-3 border rounded bg-light';
    row.innerHTML = `
      <div class="row align-items-end g-2">
        <div class="col-md-3">
          <label class="form-label mb-0">
            Hard Disk Label
            <i class="bi bi-info-circle ms-1 text-secondary scsi-tip"
               data-bs-toggle="tooltip" data-bs-placement="top"
               title="scsi(0:1)"></i>
          </label>
          <input type="text" class="form-control disk-label" value="Hard Disk 2" readonly>
          <input type="hidden" name="create_vm_disk_scsi_controller[]">
          <input type="hidden" name="create_vm_disk_unit_number[]">
        </div>
        <div class="col-md-2">
          <label class="form-label mb-0">Size (GB)</label>
          <input type="number" name="create_vm_disk_size[]" class="form-control" min="1" value="50" data-required="true">
        </div>
        <div class="col-md-5">
          <label class="form-label mb-0">Disk Provisioning</label>
          <select name="create_vm_disk_provisioning[]" class="form-select disk-provisioning" onchange="updateProvisioningValues(this)">
            <option value="thin" selected>Thin Provision</option>
            <option value="thick_lazy">Thick Provision Lazy Zeroed</option>
            <option value="thick_eager">Thick Provision Eager Zeroed</option>
          </select>
          <input type="hidden" name="create_vm_disk_thin_provisioned[]" class="thin-provisioned-value" value="true">
          <input type="hidden" name="create_vm_disk_eagerly_scrub[]" class="eagerly-scrub-value" value="false">
        </div>
        <div class="col-md-2 d-flex align-items-center">
          <button type="button" class="btn btn-sm btn-remove remove-disk-btn" onclick="removeDisk(this)">
            <i class="bi bi-trash"></i> Remove
          </button>
        </div>
      </div>
    `;
    diskContainer.appendChild(row);

    // 初始化 tooltip
    const tipIcon = row.querySelector('.scsi-tip');
    if (tipIcon) bootstrap.Tooltip.getOrCreateInstance(tipIcon);

    // 重新指派 SCSI 插槽（會自動避開 0 與 7、並在需要時擴展至 controller 1..3）
    reassignScsiSlots();
  }

  function updateProvisioningValues(selectElement) {
    const diskItem = selectElement.closest('.disk-item');
    const thinProvisionedInput = diskItem.querySelector('.thin-provisioned-value');
    const eagerlyScrubInput = diskItem.querySelector('.eagerly-scrub-value');
    const selectedValue = selectElement.value;

    switch (selectedValue) {
      case 'thin':
        thinProvisionedInput.value = 'true';
        eagerlyScrubInput.value = 'false';
        break;
      case 'thick_lazy':
        thinProvisionedInput.value = 'false';
        eagerlyScrubInput.value = 'false';
        break;
      case 'thick_eager':
        thinProvisionedInput.value = 'false';
        eagerlyScrubInput.value = 'true';
        break;
    }
  }

  function removeDisk(button) {
    const diskItem = button.closest('.disk-item');
    if (diskItem) diskItem.remove();
    // 刪除後重排（自動補位、重算 tooltip 與 hidden 值、連動 controller_count）
    reassignScsiSlots();
  }
</script>