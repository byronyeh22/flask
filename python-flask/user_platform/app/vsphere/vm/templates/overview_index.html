{% extends "base.html" %}
{% block title %}User Platform{% endblock %}
{% block content %}
<style>
    :root {
        --primary-color: #2c3e50;
        --accent-color: #3498db;
        --success-color: #27ae60;
        --warning-color: #f39c12;
        --danger-color: #e74c3c;
        --light-bg: #f8f9fa;
        --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        --border-radius: 8px;
    }

    .page-header { background: linear-gradient(135deg, var(--primary-color) 0%, #34495e 100%); color: white; padding: 2rem 0; margin: -15px -15px 30px -15px; border-radius: var(--border-radius) var(--border-radius) 0 0; position: relative; overflow: hidden; }
    .page-header::before { content: ''; position: absolute; top: 0; right: 0; width: 100px; height: 100px; background: rgba(255, 255, 255, 0.1); border-radius: 50%; transform: translate(30px, -30px); }
    .page-header h1 { margin: 0; font-weight: 300; font-size: 2.5rem; display: flex; align-items: center; gap: 1rem; }
    .page-header .subtitle { opacity: 0.9; margin-top: 0.5rem; font-size: 1.1rem; }

    .stats-row { margin-bottom: 2rem; }
    .stat-card { background: white; border-radius: var(--border-radius); padding: 1.5rem; box-shadow: var(--card-shadow); border-left: 4px solid var(--accent-color); transition: transform 0.2s ease, box-shadow 0.2s ease; text-align: center; }
    .stat-card:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15); }
    .stat-card .stat-number { font-size: 2rem; font-weight: bold; color: var(--primary-color); margin: 0; }
    .stat-card .stat-label { color: #6c757d; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; margin-top: 0.5rem; }
    .stat-card.running { border-left-color: #3498db; }
    .stat-card.success { border-left-color: #27ae60; }
    .stat-card.failed  { border-left-color: #e74c3c; }
    .stat-card.manual  { border-left-color: #f39c12; }

    .table-container { background: white; border-radius: var(--border-radius); box-shadow: var(--card-shadow); overflow: visible; margin-top: 2rem; }
    .table-header { background: var(--light-bg); padding: 1.5rem; border-bottom: 1px solid #dee2e6; }
    .table-header h3 { margin: 0; color: var(--primary-color); font-weight: 600; display: flex; align-items: center; gap: 0.5rem; }

    .search-controls { margin-top: 1rem; }
    .search-input { border: 2px solid #e9ecef; border-radius: var(--border-radius); padding: 0.75rem 1rem; transition: border-color 0.2s ease; }
    .search-input:focus { border-color: var(--accent-color); box-shadow: none; }

    .filter-btn { padding: 0.5rem 1rem; border: 2px solid #e9ecef; background: white; color: #6c757d; border-radius: var(--border-radius); transition: all 0.2s ease; margin-right: 0.5rem; cursor: pointer; }
    .filter-btn:hover, .filter-btn.active { background: var(--accent-color); color: white; border-color: var(--accent-color); }

    .pagination-controls { background: var(--light-bg); padding: 1rem 1.5rem; border-top: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
    .entries-control { display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: #6c757d; }
    .entries-select { padding: 0.4rem 0.8rem; border: 1px solid #dee2e6; border-radius: var(--border-radius); background: white; font-size: 0.9rem; }
    .entries-select:focus { outline: none; border-color: var(--accent-color); }
    .pagination-info { font-size: 0.9rem; color: #6c757d; }
    .pagination-nav { display: flex; gap: 0.5rem; align-items: center; }
    .pagination-btn { padding: 0.5rem 0.75rem; border: 1px solid #dee2e6; background: white; color: #6c757d; border-radius: var(--border-radius); cursor: pointer; transition: all 0.2s ease; font-size: 0.85rem; min-width: 35px; text-align: center; }
    .pagination-btn:hover:not(:disabled) { background: var(--accent-color); color: white; border-color: var(--accent-color); }
    .pagination-btn.active { background: var(--accent-color); color: white; border-color: var(--accent-color); }
    .pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .custom-table { margin: 0; border: none; font-size: 0.85rem; }
    .custom-table thead th { background: var(--primary-color); color: white; border: none; padding: 1rem; font-weight: 500; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.5px; white-space: nowrap; text-align: center; }

    .custom-table tbody td { padding: 1rem; vertical-align: middle; border-bottom: 1px solid #f1f3f4; }
    .custom-table tbody tr:hover { background-color: rgba(52, 152, 219, 0.05); }

    /* 置中欄位（插入 Environment 後索引位移）*/
    .custom-table tbody td:nth-child(1),  /* Workflow ID */
    .custom-table tbody td:nth-child(2),  /* Ticket ID */
    .custom-table tbody td:nth-child(3),  /* Environment */
    .custom-table tbody td:nth-child(5),  /* Status */
    .custom-table tbody td:nth-child(8),  /* Duration */
    .custom-table tbody td:nth-child(9)   /* Action */
    { text-align: center; }

    .status-badge { padding: 0.4rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; display: inline-block; min-width: 70px; text-align: center; }
    .status-success { background: rgba(39,174,96,0.2); color: #27ae60; }
    .status-failed  { background: rgba(231,76,60,0.2); color: #e74c3c; }
    .status-created,
    .status-running,
    .status-pending,
    .status-preparing,
    .status-canceled,
    .status-waiting_for_resource { background: rgba(52,152,219,0.2); color: #3498db; }
    .status-manual  { background: rgba(241,196,15,0.2); color: #f39c12; }
    .status-approved{ background: rgba(46,204,113,0.2); color: #2ecc71; }
    .status-draft   { background: rgba(108,117,125,0.2); color: #6c757d; }

    .workflow-id { font-family: 'Courier New', monospace; background: rgba(52, 152, 219, 0.1); padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.9rem; color: var(--accent-color); font-weight: 500; }
    .ticket-link { color: var(--accent-color); text-decoration: none; font-weight: 500; transition: color 0.2s ease; }
    .ticket-link:hover { color: var(--primary-color); text-decoration: underline; }

    .date-cell { white-space: nowrap; min-width: 120px; }

    /* Summary：顯示完整字串（維持你原本的風格） */
    .summary-cell { white-space: normal; overflow: visible; max-width: none; word-break: break-word; }

    .search-controls { margin-top: 1rem; display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }
    .search-section { display: flex; align-items: center; gap: 0.5rem; flex: 1; min-width: 300px; }
    .search-label { font-weight: 500; color: var(--primary-color); white-space: nowrap; }
    .filter-section { display: flex; align-items: center; gap: 0.5rem; flex-wrap: nowrap; }
    .filter-btn { padding: 0.5rem 1rem; border: 2px solid #e9ecef; background: white; color: #6c757d; border-radius: var(--border-radius); transition: all 0.2s ease; cursor: pointer; white-space: nowrap; font-size: 0.85rem; }

    /* Review Modal iframe 尺寸（沿用你原本設定） */
    .modal-xl { max-width: 95vw; }
    .review-iframe { width: 100%; height: 80vh; border: none; }
</style>

<div class="container-fluid">
    <!-- Statistics Cards -->
    <div class="row stats-row">
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="stat-card running">
                <div class="stat-number">
                    {{ pipeline_data | selectattr('status', 'in', ['created', 'waiting_for_resource', 'preparing', 'pending', 'running']) | list | length }}
                </div>
                <div class="stat-label">Running</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="stat-card success">
                <div class="stat-number">
                    {{ pipeline_data | selectattr('status', 'equalto', 'success') | list | length }}
                </div>
                <div class="stat-label">Success</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="stat-card failed">
                <div class="stat-number">
                    {{ pipeline_data | selectattr('status', 'equalto', 'failed') | list | length }}
                </div>
                <div class="stat-label">Failed</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="stat-card manual">
                <div class="stat-number">
                    {{ pipeline_data | selectattr('status', 'equalto', 'manual') | list | length }}
                </div>
                <div class="stat-label">Approved</div>
            </div>
        </div>
    </div>

    <!-- Pipeline + Draft Table -->
    <div class="table-container">
        <div class="table-header">
            <div class="search-controls">
                <div class="position-relative w-100" style="max-width: 600px;">
                  <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-3 text-muted"></i>
                  <input type="text" class="form-control ps-5 rounded-pill" placeholder="Search" id="searchInput">
                </div>
                <div class="filter-section">
                    <button class="filter-btn active" data-status="all">All</button>
                    <button class="filter-btn" data-status="success">Success</button>
                    <button class="filter-btn" data-status="failed">Failed</button>
                    <button class="filter-btn" data-status="manual">Approved</button>
                    <button class="filter-btn" data-status="created">Running</button>
                    <button class="filter-btn" data-status="draft">Draft</button>
                </div>
                <div class="timezone-control d-flex align-items-center gap-2 small">
                    <span class="timezone-label fw-bold"><i class="fas fa-globe me-1"></i> Timezone</span>
                    <select class="timezone-select form-select form-select-sm w-auto" id="timezoneSelect">
                        <option value="local">Local time</option>
                        <option value="UTC">UTC</option>
                        <option value="America/New_York">EST (New York)</option>
                        <option value="America/Los_Angeles">PST (Los Angeles)</option>
                        <option value="Europe/London">GMT (London)</option>
                        <option value="Europe/Paris">CET (Paris)</option>
                        <option value="Asia/Tokyo">JST (Tokyo)</option>
                        <option value="Asia/Singapore">SGT (Singapore)</option>
                        <option value="Australia/Sydney">AEDT (Sydney)</option>
                    </select>
                </div>
                <div id="refreshStatus" class="text-muted small my-2 ms-2"></div>
            </div>
        </div>

        <table class="table custom-table" id="pipelinesTable">
            <thead>
                <tr>
                    <th><i class="fas fa-code"></i> Workflow ID</th>
                    <th><i class="fas fa-ticket-alt"></i> Ticket ID</th>
                    <th>Environment</th>
                    <th><i class="fas fa-list"></i> Summary</th>
                    <th><i class="fas fa-info-circle"></i> Status</th>
                    <th><i class="fas fa-calendar-plus"></i> Start</th>
                    <th><i class="fas fa-calendar-check"></i> End</th>
                    <th><i class="fas fa-stopwatch"></i> Duration</th>
                    <th><i class="fas fa-check"></i> Action</th>
                </tr>
            </thead>
            <tbody>
                {% for pipeline in (pipeline_data | sort(attribute='created_at', reverse=True)) %}
                {% set jira_ticket = (jira_tickets | selectattr('workflow_id', 'equalto', pipeline.workflow_id) | list | first) %}
                {% set raw_status = pipeline.status.lower() %}
                {% set normalized_status = raw_status %}

                {# 解析 Environment：依你 _generate_create_summary 的格式
                   "[VM Provisioning] {env} - {action} ..." #}
                {% set summary_txt = (jira_ticket.summary if jira_ticket else '') %}
                {% set env_val = '-' %}
                {% if summary_txt %}
                    {% set parts = summary_txt.split(']') %}
                    {% if parts|length > 1 %}
                        {% set after = parts[1].strip() %}
                        {% set env_val = after.split(' - ')[0].strip() %}
                    {% endif %}
                {% endif %}
                {% set env_upper = env_val.upper() if env_val != '-' else '-' %}

                <tr data-status="{{ normalized_status }}">
                    <td><span class="workflow-id">{{ pipeline.workflow_id }}</span></td>
                    <td>
                        {% if jira_ticket and jira_ticket.ticket_id %}
                            <a href="{{ jira_ticket.url }}" target="_blank" class="ticket-link">{{ jira_ticket.ticket_id }}</a>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>{{ env_upper }}</td>
                    <td class="summary-cell">
                        {{ jira_ticket.summary if jira_ticket else '-' }}
                    </td>
                    <td>
                        <span class="status-badge status-{{ normalized_status }}">{{ pipeline.status }}</span>
                    </td>
                    <td class="date-cell" data-datetime="{{ pipeline.created_at }}">{{ pipeline.created_at }}</td>
                    <td class="date-cell" data-datetime="{{ pipeline.finished_at }}">{{ pipeline.finished_at or '-' }}</td>
                    <td class="duration-cell" data-seconds="{{ pipeline.duration or 0 }}"></td>
                    <td>
                        {% if normalized_status == 'draft' %}
                              <div class="actions-draft">
                                <button type="button"
                                        class="btn btn-sm btn-outline-primary btn-draft-edit"
                                        data-action="edit"
                                        data-workflow-id="{{ pipeline.workflow_id }}"
                                        title="Edit">
                                  <i class="bi bi-pencil-square"></i>
                                </button>
                                <a class="btn btn-sm btn-outline-secondary btn-draft-review"
                                   data-workflow-id="{{ pipeline.workflow_id }}"
                                   title="Review">
                                  <i class="bi bi-eye"></i>
                                </a>
                                <button type="button"
                                        class="btn btn-sm btn-outline-danger btn-draft-delete"
                                        data-action="delete"
                                        data-workflow-id="{{ pipeline.workflow_id }}"
                                        title="Delete">
                                  <i class="bi bi-trash"></i>
                                </button>
                              </div>
                        {% elif normalized_status == 'manual' %}
                            <a href="{{ url_for('vm.pipeline_approve', pipeline_id=pipeline.pipeline_id) }}" class="btn btn-sm btn-primary">Approve</a>
                        {% else %}
                            <button class="btn btn-sm btn-secondary" disabled>Approve</button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="pagination-controls">
            <div class="entries-control">
                <span>Show</span>
                <select class="entries-select" id="entriesPerPage">
                    <option value="5">5</option>
                    <option value="10" selected>10</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
                <span>entries</span>
            </div>

            <div class="pagination-info" id="paginationInfo">
                Showing 1 to 10 of 0 entries
            </div>

            <div class="pagination-nav" id="paginationNav">
                <button class="pagination-btn" id="firstPage" title="First">&laquo;</button>
                <button class="pagination-btn" id="prevPage" title="Previous">&lsaquo;</button>
                <span id="pageNumbers"></span>
                <button class="pagination-btn" id="nextPage" title="Next">&rsaquo;</button>
                <button class="pagination-btn" id="lastPage" title="Last">&raquo;</button>
            </div>
        </div>
    </div>
</div>

<!-- Review Modal（iframe 載入既有 review.html） -->
<div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="reviewModalLabel">Review Request</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-0">
        <iframe id="reviewFrame" class="review-iframe"></iframe>
      </div>
      <div class="modal-footer">
        <!-- 這裡暫不放 Approve/Submit；待後端路由完成後再掛 -->
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ========================================================================
 * Router URL templates（後端路由樣板）
 * - 以 "0" 為佔位，前端在點擊時替換為實際 workflow_id
 * ====================================================================== */
const REVIEW_URL_TMPL = "{{ url_for('vm.workflow_review_page', workflow_id=0) }}";
const EDIT_URL_TMPL   = "{{ url_for('vm.workflow_draft_edit',  workflow_id=0) }}";
const DELETE_URL_TMPL = "{{ url_for('vm.workflow_draft_delete',workflow_id=0) }}";

/* ========================================================================
 * TimezoneManager：負責把 .date-cell[data-datetime] 依使用者選擇時區顯示
 * - 只動「顯示文字」，不改原本儲存在 data-datetime 的原始字串
 * - 預設 currentTimezone = 'local'
 * ====================================================================== */
class TimezoneManager {
  constructor() {
    this.currentTimezone = 'local';
    this.timezoneSelect  = document.getElementById('timezoneSelect');
    this._bindEvents();
    this._detectUserTimezoneLabel();
    this.updateAllDateCells();
  }

  _bindEvents() {
    if (!this.timezoneSelect) return;
    this.timezoneSelect.addEventListener('change', (e) => {
      this.currentTimezone = e.target.value;
      this.updateAllDateCells();
    });
  }

  _detectUserTimezoneLabel() {
    // 將 Local time 選項補上實際時區字樣（純顯示）
    try {
      const userTz = Intl.DateTimeFormat().resolvedOptions().timeZone;
      const localOption = this.timezoneSelect?.querySelector('option[value="local"]');
      if (localOption) localOption.textContent = `Local time (${userTz})`;
    } catch (e) {
      console.warn('Cannot detect user timezone:', e);
    }
  }

  // 將日期字串格式化為選定時區的顯示（不改原值）
  _formatDateTime(datetimeStr, timezone) {
    if (!datetimeStr || datetimeStr === '-' || datetimeStr === 'None') return '-';
    try {
      const date = new Date(datetimeStr);
      if (isNaN(date.getTime())) return datetimeStr; // 無效日期就原樣顯示
      const opts = {
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit', second: '2-digit',
        hour12: false
      };
      if (timezone !== 'local') opts.timeZone = timezone;
      // 使用 en-CA 方便得到 YYYY-MM-DD HH:mm:ss 格式
      return date.toLocaleString('en-CA', opts).replace(',', '');
    } catch (e) {
      console.error('Error formatting date:', e);
      return datetimeStr;
    }
  }

  // 針對頁面上所有日期欄位做一次渲染
  updateAllDateCells() {
    document.querySelectorAll('.date-cell[data-datetime]').forEach(cell => {
      const raw = cell.getAttribute('data-datetime');
      cell.textContent = this._formatDateTime(raw, this.currentTimezone);
    });
  }

  // 供外部新進資料時使用
  formatNewDateTime(datetimeStr) {
    return this._formatDateTime(datetimeStr, this.currentTimezone);
  }
}

/* ========================================================================
 * TablePagination：表格的搜尋 / 狀態篩選 / 分頁 / 自動刷新 / Draft 操作
 * - 不動你原本的資料結構與欄位
 * - 會依據 .filter-btn 的 data-status 做狀態過濾
 * - 搜尋會掃描該列所有儲存格文字
 * - 自動刷新：定時重抓當前頁 HTML，覆蓋 <tbody> 後重建索引
 * ====================================================================== */
class TablePagination {
  constructor() {
    // 狀態與快取
    this.currentPage     = 1;
    this.entriesPerPage  = 10;
    this.currentFilter   = 'all';
    this.tableBody       = document.querySelector('#pipelinesTable tbody');
    this.allRows         = Array.from(this.tableBody?.querySelectorAll('tr') || []);
    this.filteredRows    = [...this.allRows];

    // UI 元素
    this.searchInput     = document.getElementById('searchInput');
    this.entriesSelect   = document.getElementById('entriesPerPage');
    this.paginationInfo  = document.getElementById('paginationInfo');
    this.pageNumbers     = document.getElementById('pageNumbers');
    this.firstPageBtn    = document.getElementById('firstPage');
    this.prevPageBtn     = document.getElementById('prevPage');
    this.nextPageBtn     = document.getElementById('nextPage');
    this.lastPageBtn     = document.getElementById('lastPage');
    this.filterButtons   = document.querySelectorAll('.filter-btn');

    this._bindEvents();
    this.applyFilters();
    this.updateDisplay();
    this._startAutoRefresh();
  }

  /* ---------------------- 綁定所有互動事件 ---------------------- */
  _bindEvents() {
    // 搜尋
    if (this.searchInput) {
      this.searchInput.addEventListener('input', () => {
        this.applyFilters();
        this.currentPage = 1;
        this.updateDisplay();
      });
    }

    // 每頁筆數
    if (this.entriesSelect) {
      this.entriesSelect.addEventListener('change', (e) => {
        this.entriesPerPage = parseInt(e.target.value, 10);
        this.currentPage = 1;
        this.updateDisplay();
      });
    }

    // 狀態篩選
    this.filterButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        this.filterButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        this.currentFilter = btn.dataset.status;
        this.applyFilters();
        this.currentPage = 1;
        this.updateDisplay();
      });
    });

    // Draft：Review / Edit / Delete（事件委派）
    document.addEventListener('click', async (e) => {
      const reviewBtn = e.target.closest('.btn-draft-review');
      const editBtn   = e.target.closest('.btn-draft-edit');
      const deleteBtn = e.target.closest('.btn-draft-delete');

      // Review：開 modal + 內嵌 iframe 顯示 review 頁
      if (reviewBtn) {
        const wfId = reviewBtn.getAttribute('data-workflow-id');
        const src  = REVIEW_URL_TMPL.replace('0', wfId);
        const frame = document.getElementById('reviewFrame');
        if (frame) frame.src = src;
        const modal = new bootstrap.Modal(document.getElementById('reviewModal'));
        modal.show();
        return;
      }

      // Edit：導向草稿編輯頁（後端會用 request_payload 回填到 create form）
      if (editBtn) {
        const wfId = editBtn.getAttribute('data-workflow-id');
        window.location.href = EDIT_URL_TMPL.replace('0', wfId);
        return;
      }

      // Delete：刪除 DB 中的草稿，刪列並重建索引
      if (deleteBtn) {
        const wfId = deleteBtn.getAttribute('data-workflow-id');
        if (!confirm(`Delete Draft #${wfId}?`)) return;

        try {
          const resp = await fetch(DELETE_URL_TMPL.replace('0', wfId), {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
          });
          if (!resp.ok) {
            const txt = await resp.text();
            alert('Delete failed: ' + txt);
            return;
          }
          const row = e.target.closest('tr');
          if (row) row.remove();
          this._reindexRows();
        } catch (err) {
          console.error(err);
          alert('Network error while deleting draft.');
        }
        return;
      }
    });

    // 分頁按鈕
    this.firstPageBtn?.addEventListener('click', () => this.goToPage(1));
    this.prevPageBtn?.addEventListener('click',  () => this.goToPage(this.currentPage - 1));
    this.nextPageBtn?.addEventListener('click',  () => this.goToPage(this.currentPage + 1));
    this.lastPageBtn?.addEventListener('click',  () => this.goToPage(this.getTotalPages()));
  }

  /* ---------------------- 過濾（搜尋 + 狀態） ---------------------- */
  applyFilters() {
    const term = (this.searchInput?.value || '').toLowerCase();

    // 基本過濾：狀態 + 關鍵字
    this.filteredRows = this.allRows.filter(row => {
      if (this.currentFilter !== 'all' && row.dataset.status !== this.currentFilter) return false;
      if (!term) return true;
      return Array.from(row.cells).some(td => td.textContent.toLowerCase().includes(term));
    });

    // 如果你還有時間區間過濾（window.__timeFilter），可保留以下擴充：
    // const tf = window.__timeFilter || {};
    // if (tf.start || tf.end) { ... }
  }

  /* ---------------------- 顯示（分頁、資訊、頁碼、時長） ---------------------- */
  updateDisplay() {
    const totalEntries = this.filteredRows.length;
    const totalPages   = this.getTotalPages();

    if (this.currentPage > totalPages) this.currentPage = totalPages || 1;
    const start = (this.currentPage - 1) * this.entriesPerPage;
    const end   = start + this.entriesPerPage;

    // 顯示/隱藏列
    this.allRows.forEach(row => row.style.display = 'none');
    this.filteredRows.slice(start, end).forEach(row => row.style.display = '');

    // 分頁資訊
    const showingStart = totalEntries === 0 ? 0 : start + 1;
    const showingEnd   = Math.min(end, totalEntries);
    if (this.paginationInfo) {
      this.paginationInfo.textContent = `Showing ${showingStart} to ${showingEnd} of ${totalEntries} entries`;
    }

    // 分頁按鈕狀態
    const atFirst = this.currentPage === 1;
    const atLast  = this.currentPage === totalPages || totalPages === 0;
    if (this.firstPageBtn) this.firstPageBtn.disabled = atFirst;
    if (this.prevPageBtn)  this.prevPageBtn.disabled  = atFirst;
    if (this.nextPageBtn)  this.nextPageBtn.disabled  = atLast;
    if (this.lastPageBtn)  this.lastPageBtn.disabled  = atLast;

    // 頁碼區
    this._renderPageNumbers(totalPages);

    // 時長欄位（秒 → XmYs）
    this._updateDurationCells();
  }

  /* ---------------------- 自動刷新（每 3 秒） ---------------------- */
  _startAutoRefresh() {
    const intervalMs  = 3000;
    const refreshHint = document.getElementById('refreshStatus');

    setInterval(() => {
      if (refreshHint) {
        const now = new Date().toLocaleTimeString();
        refreshHint.textContent = `Refreshing data every ${intervalMs / 1000} seconds... (${now})`;
      }
      this._refreshData();
    }, intervalMs);
  }

  // 重新抓整頁 HTML，覆蓋 <tbody>，重建索引與顯示
  _refreshData() {
    fetch(window.location.href)
      .then(res => res.text())
      .then(html => {
        const doc = new DOMParser().parseFromString(html, 'text/html');
        const newTbody = doc.querySelector('#pipelinesTable tbody');
        if (!newTbody || !this.tableBody) return;

        this.tableBody.innerHTML = newTbody.innerHTML;
        this._reindexRows();
      })
      .catch(err => console.error('刷新資料失敗:', err));
  }

  // 重建列集合並重跑過濾與顯示
  _reindexRows() {
    this.allRows = Array.from(this.tableBody.querySelectorAll('tr'));
    this.applyFilters();
    this.updateDisplay();
  }

  /* ---------------------- 工具方法 ---------------------- */
  getTotalPages() {
    return Math.ceil(this.filteredRows.length / this.entriesPerPage);
  }

  goToPage(page) {
    const totalPages = this.getTotalPages();
    const p = Math.max(1, Math.min(page, totalPages || 1));
    if (p === this.currentPage) return;
    this.currentPage = p;
    this.updateDisplay();
  }

  _renderPageNumbers(totalPages) {
    if (!this.pageNumbers) return;
    this.pageNumbers.innerHTML = '';

    const max = 7;
    let start = Math.max(this.currentPage - Math.floor(max / 2), 1);
    let end   = start + max - 1;
    if (end > totalPages) {
      end = totalPages;
      start = Math.max(end - max + 1, 1);
    }

    for (let i = start; i <= end; i++) {
      const btn = document.createElement('button');
      btn.textContent = i;
      btn.classList.add('pagination-btn');
      if (i === this.currentPage) {
        btn.classList.add('active');
        btn.disabled = true;
      }
      btn.addEventListener('click', () => this.goToPage(i));
      this.pageNumbers.appendChild(btn);
    }
  }

  _updateDurationCells() {
    document.querySelectorAll('.duration-cell').forEach(cell => {
      const seconds = parseInt(cell.dataset.seconds, 10);
      if (isNaN(seconds) || seconds <= 0) {
        cell.textContent = '-';
      } else {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        cell.textContent = `${mins > 0 ? `${mins}m` : ''}${secs}s`;
      }
    });
  }
}

/* ========================================================================
 * 入口：初始化 Timezone 顯示與表格控制
 * ====================================================================== */
document.addEventListener('DOMContentLoaded', () => {
  const timezoneManager = new TimezoneManager();
  const tablePagination = new TablePagination();

  // 讓其他模組（若有）可以呼叫
  window.timezoneManager = timezoneManager;
  window.tablePagination = tablePagination;
});


/* ==========================================================================
 * Time Range Filter (single box, 24h sliders)
 * - 插入到 .search-controls，位置在 Timezone 選單後
 * - 以 window.__timeFilter = {start:number|null, end:number|null} 與表格整合
 * - 以「包裝」方式擴充 tablePagination.applyFilters()，不修改原類別程式
 * ======================================================================== */
(function addTimeRangeFilterBox() {
  const sc = document.querySelector('.search-controls');
  if (!sc) return;

  // ---- 找到 Timezone 控制區塊，插在它後面 ----
  const tzSelect = document.getElementById('timezoneSelect');
  const tzBlock  = tzSelect ? tzSelect.closest('.timezone-control') : null;

  // ---- 少量樣式（不影響你的原本 CSS） ----
  const style = document.createElement('style');
  style.textContent = `
    .trf-wrap{position:relative;min-width:280px;}
    .trf-toggle{cursor:pointer;}
    .trf-panel{position:absolute;top:calc(100% + 6px);left:0;width:340px;background:#fff;z-index:1051;border:1px solid #e9ecef;box-shadow:0 8px 24px rgba(0,0,0,.12);display:none;border-radius:.5rem;}
    .trf-panel .hdr{padding:.75rem 1rem;border-bottom:1px solid #f1f3f5;font-weight:600;background:#f8f9fa;border-top-left-radius:.5rem;border-top-right-radius:.5rem;}
    .trf-panel .body{padding:1rem;}
    .trf-row{display:grid;grid-template-columns:1fr;gap:.5rem;margin-bottom:1rem;}
    .trf-row .date{display:flex;gap:.5rem;}
    .trf-row .date input[type="date"]{flex:1;}
    .trf-time{display:grid;grid-template-columns:1fr 1fr;gap:.75rem;align-items:center;}
    .trf-time .col{display:flex;flex-direction:column;gap:.25rem;}
    .trf-time output{font-variant-numeric:tabular-nums;min-width:2ch}
    .trf-actions{display:flex;justify-content:space-between;gap:.5rem;padding:0 1rem 1rem 1rem;}
    .trf-actions .btn{min-width:80px}
    .trf-label{font-size:.875rem;color:#6c757d}
  `;
  document.head.appendChild(style);

  // ---- 元件骨架 ----
  const wrap = document.createElement('div');
  wrap.className = 'trf-wrap';
  wrap.innerHTML = `
    <button type="button" class="trf-toggle form-control ps-3 pe-2 py-1 d-flex align-items-center justify-content-between">
      <span class="d-inline-flex align-items-center gap-2">
        <i class="bi bi-clock-history"></i>
        <span id="trfLabel">Time Filter</span>
      </span>
      <i class="bi bi-chevron-down ms-2"></i>
    </button>
    <div class="trf-panel" id="trfPanel">
      <div class="hdr">Time range (24h)</div>
      <div class="body">
        <!-- From -->
        <div class="trf-row">
          <div class="trf-label">From</div>
          <div class="date">
            <input type="date" id="trfFromDate" class="form-control form-control-sm">
          </div>
          <div class="trf-time">
            <div class="col">
              <label class="small text-muted">Hour (0–23): <output id="trfFromHourOut">00</output></label>
              <input type="range" id="trfFromHour" min="0" max="23" step="1" value="0" class="form-range">
            </div>
            <div class="col">
              <label class="small text-muted">Minute (0–59): <output id="trfFromMinOut">00</output></label>
              <input type="range" id="trfFromMin" min="0" max="59" step="1" value="0" class="form-range">
            </div>
          </div>
        </div>
        <!-- To -->
        <div class="trf-row">
          <div class="trf-label">To</div>
          <div class="date">
            <input type="date" id="trfToDate" class="form-control form-control-sm">
          </div>
          <div class="trf-time">
            <div class="col">
              <label class="small text-muted">Hour (0–23): <output id="trfToHourOut">23</output></label>
              <input type="range" id="trfToHour" min="0" max="23" step="1" value="23" class="form-range">
            </div>
            <div class="col">
              <label class="small text-muted">Minute (0–59): <output id="trfToMinOut">59</output></label>
              <input type="range" id="trfToMin" min="0" max="59" step="1" value="59" class="form-range">
            </div>
          </div>
        </div>
      </div>
      <div class="trf-actions">
        <button type="button" class="btn btn-sm btn-outline-secondary" id="trfClear">Clear</button>
        <button type="button" class="btn btn-sm btn-primary" id="trfApply">Apply</button>
      </div>
    </div>
  `;

  // 插入位置：在 Timezone 控件後；若找不到，就加在 .search-controls 末尾
  if (tzBlock && tzBlock.nextSibling) {
    sc.insertBefore(wrap, tzBlock.nextSibling);
  } else {
    sc.appendChild(wrap);
  }

  // ---- 狀態與 util ----
  window.__timeFilter = { start: null, end: null };

  const pad2 = n => String(n).padStart(2,'0');
  const labelEl = wrap.querySelector('#trfLabel');
  const panel   = wrap.querySelector('#trfPanel');
  const toggle  = wrap.querySelector('.trf-toggle');

  const fromDate = wrap.querySelector('#trfFromDate');
  const fromH    = wrap.querySelector('#trfFromHour');
  const fromM    = wrap.querySelector('#trfFromMin');
  const fromHO   = wrap.querySelector('#trfFromHourOut');
  const fromMO   = wrap.querySelector('#trfFromMinOut');

  const toDate = wrap.querySelector('#trfToDate');
  const toH    = wrap.querySelector('#trfToHour');
  const toM    = wrap.querySelector('#trfToMin');
  const toHO   = wrap.querySelector('#trfToHourOut');
  const toMO   = wrap.querySelector('#trfToMinOut');

  const btnApply = wrap.querySelector('#trfApply');
  const btnClear = wrap.querySelector('#trfClear');

  // 初始化預設顯示為今天（在地時區）
  const todayISO = () => {
    const d = new Date();
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  };
  fromDate.value = todayISO();
  toDate.value   = todayISO();

  const updateOutputs = () => {
    fromHO.textContent = pad2(fromH.value);
    fromMO.textContent = pad2(fromM.value);
    toHO.textContent   = pad2(toH.value);
    toMO.textContent   = pad2(toM.value);
  };
  updateOutputs();

  const openPanel  = () => panel.style.display = 'block';
  const closePanel = () => panel.style.display = 'none';

  toggle.addEventListener('click', (e)=>{
    e.stopPropagation();
    const visible = panel.style.display !== 'none';
    visible ? closePanel() : openPanel();
  });
  document.addEventListener('click', (e)=>{
    if (!panel.contains(e.target) && !toggle.contains(e.target)) closePanel();
  });

  [fromH, fromM, toH, toM].forEach(inp => {
    inp.addEventListener('input', updateOutputs);
  });

  const toTsLocal = (dStr, h, m) => {
    if (!dStr) return null;
    const d = new Date(`${dStr}T00:00:00`);
    if (isNaN(d.getTime())) return null;
    d.setHours(Number(h||0));
    d.setMinutes(Number(m||0));
    d.setSeconds(0);
    d.setMilliseconds(0);
    return d.getTime();
  };

  const updateLabel = () => {
    const tf = window.__timeFilter;
    if (!tf.start && !tf.end) {
      labelEl.textContent = 'Time Filter';
      return;
    }
    const fmt = ts => {
      const d = new Date(ts);
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
    };
    const s = tf.start ? fmt(tf.start) : '';
    const e = tf.end   ? fmt(tf.end)   : '';
    labelEl.textContent = `${s}${s&&e?' ~ ':''}${e}` || 'Time Filter';
  };

  btnApply.addEventListener('click', ()=>{
    const s = toTsLocal(fromDate.value, fromH.value, fromM.value);
    const e = toTsLocal(toDate.value,   toH.value,   toM.value);
    window.__timeFilter.start = s;
    window.__timeFilter.end   = e;
    updateLabel();
    closePanel();
    // 觸發重算
    if (window.tablePagination) {
      window.tablePagination.applyFilters();
      window.tablePagination.currentPage = 1;
      window.tablePagination.updateDisplay();
    }
  });

  btnClear.addEventListener('click', ()=>{
    window.__timeFilter.start = null;
    window.__timeFilter.end   = null;
    // 重設 UI（保留日期，時間歸 00:00~23:59）
    fromH.value = 0;  fromM.value = 0;
    toH.value   = 23; toM.value   = 59;
    updateOutputs();
    updateLabel();
    if (window.tablePagination) {
      window.tablePagination.applyFilters();
      window.tablePagination.currentPage = 1;
      window.tablePagination.updateDisplay();
    }
  });

  // ---- 包裝 tablePagination.applyFilters：加入時間區間過濾，不改原程式 ----
  document.addEventListener('DOMContentLoaded', () => {
    if (!window.tablePagination) return;
    const tp = window.tablePagination;
    if (tp.__trf_patched) return; // 避免重複包裝

    const origApply = tp.applyFilters.bind(tp);
    tp.applyFilters = function () {
      // 先跑原本的搜尋/狀態過濾
      origApply();
      // 再套時間區間
      const tf = window.__timeFilter || {};
      if (!tf.start && !tf.end) return;

      const inRange = (ms) => {
        if (ms == null) return false;
        if (tf.start && ms < tf.start) return false;
        if (tf.end   && ms > tf.end)   return false;
        return true;
      };

      this.filteredRows = this.filteredRows.filter(row => {
        // 以「Start」欄位（第一個 .date-cell[data-datetime]）為判斷依據
        const startCell = row.querySelector('td.date-cell[data-datetime]');
        if (!startCell) return false;
        const raw = (startCell.getAttribute('data-datetime') || '').replace(' ', 'T');
        const dt  = new Date(raw);
        const ms  = isNaN(dt.getTime()) ? null : dt.getTime();
        return inRange(ms);
      });
    };

    tp.__trf_patched = true;
  });

})();



</script>

{% endblock %}