{% extends "base.html" %}
{% block title %}User Platform{% endblock %}
{% block content %}
<style>
    :root {
        --primary-color: #2c3e50;
        --accent-color: #3498db;
        --success-color: #27ae60;
        --warning-color: #f39c12;
        --danger-color: #e74c3c;
        --light-bg: #f8f9fa;
        --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        --border-radius: 8px;
    }

    .page-header { background: linear-gradient(135deg, var(--primary-color) 0%, #34495e 100%); color: white; padding: 2rem 0; margin: -15px -15px 30px -15px; border-radius: var(--border-radius) var(--border-radius) 0 0; position: relative; overflow: hidden; }
    .page-header::before { content: ''; position: absolute; top: 0; right: 0; width: 100px; height: 100px; background: rgba(255, 255, 255, 0.1); border-radius: 50%; transform: translate(30px, -30px); }
    .page-header h1 { margin: 0; font-weight: 300; font-size: 2.5rem; display: flex; align-items: center; gap: 1rem; }
    .page-header .subtitle { opacity: 0.9; margin-top: 0.5rem; font-size: 1.1rem; }

    .stats-row { margin-bottom: 2rem; }
    .stat-card { background: white; border-radius: var(--border-radius); padding: 1.5rem; box-shadow: var(--card-shadow); border-left: 4px solid var(--accent-color); transition: transform 0.2s ease, box-shadow 0.2s ease; text-align: center; }
    .stat-card:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15); }
    .stat-card .stat-number { font-size: 2rem; font-weight: bold; color: var(--primary-color); margin: 0; }
    .stat-card .stat-label { color: #6c757d; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; margin-top: 0.5rem; }
    .stat-card.running { border-left-color: #3498db; }
    .stat-card.success { border-left-color: #27ae60; }
    .stat-card.failed  { border-left-color: #e74c3c; }
    .stat-card.manual  { border-left-color: #f39c12; }

    .table-container { background: white; border-radius: var(--border-radius); box-shadow: var(--card-shadow); overflow: visible; margin-top: 2rem; }
    .table-header { background: var(--light-bg); padding: 1.5rem; border-bottom: 1px solid #dee2e6; }
    .table-header h3 { margin: 0; color: var(--primary-color); font-weight: 600; display: flex; align-items: center; gap: 0.5rem; }

    .search-controls { margin-top: 1rem; }
    .search-input { border: 2px solid #e9ecef; border-radius: var(--border-radius); padding: 0.75rem 1rem; transition: border-color 0.2s ease; }
    .search-input:focus { border-color: var(--accent-color); box-shadow: none; }

    .filter-btn { padding: 0.5rem 1rem; border: 2px solid #e9ecef; background: white; color: #6c757d; border-radius: var(--border-radius); transition: all 0.2s ease; margin-right: 0.5rem; cursor: pointer; }
    .filter-btn:hover, .filter-btn.active { background: var(--accent-color); color: white; border-color: var(--accent-color); }

    .pagination-controls { background: var(--light-bg); padding: 1rem 1.5rem; border-top: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
    .entries-control { display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: #6c757d; }
    .entries-select { padding: 0.4rem 0.8rem; border: 1px solid #dee2e6; border-radius: var(--border-radius); background: white; font-size: 0.9rem; }
    .entries-select:focus { outline: none; border-color: var(--accent-color); }
    .pagination-info { font-size: 0.9rem; color: #6c757d; }
    .pagination-nav { display: flex; gap: 0.5rem; align-items: center; }
    .pagination-btn { padding: 0.5rem 0.75rem; border: 1px solid #dee2e6; background: white; color: #6c757d; border-radius: var(--border-radius); cursor: pointer; transition: all 0.2s ease; font-size: 0.85rem; min-width: 35px; text-align: center; }
    .pagination-btn:hover:not(:disabled) { background: var(--accent-color); color: white; border-color: var(--accent-color); }
    .pagination-btn.active { background: var(--accent-color); color: white; border-color: var(--accent-color); }
    .pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .custom-table { margin: 0; border: none; font-size: 0.85rem; }
    .custom-table thead th { background: var(--primary-color); color: white; border: none; padding: 1rem; font-weight: 500; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.5px; white-space: nowrap; text-align: center; }

    .custom-table tbody td { padding: 1rem; vertical-align: middle; border-bottom: 1px solid #f1f3f4; }
    .custom-table tbody tr:hover { background-color: rgba(52, 152, 219, 0.05); }

    .custom-table tbody td:nth-child(1),
    .custom-table tbody td:nth-child(2),
    .custom-table tbody td:nth-child(3),
    .custom-table tbody td:nth-child(5),
    .custom-table tbody td:nth-child(8),
    .custom-table tbody td:nth-child(9)
    { text-align: center; }

    .status-badge { padding: 0.4rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; display: inline-block; min-width: 70px; text-align: center; }
    .status-in_progress { background: rgba(52,152,219,0.2); color: #3498db; }      /* IN_PROGRESS */
    .status-pending_approval { background: rgba(241,196,15,0.2); color: #f39c12; } /* PENDING_APPROVAL */
    .status-success { background: rgba(39,174,96,0.2); color: #27ae60; }
    .status-failed  { background: rgba(231,76,60,0.2); color: #e74c3c; }
    .status-canceled,
    .status-approved{ background: rgba(46,204,113,0.2); color: #2ecc71; }
    .status-draft   { background: rgba(108,117,125,0.2); color: #6c757d; }

    .workflow-id { font-family: 'Courier New', monospace; background: rgba(52, 152, 219, 0.1); padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.9rem; color: var(--accent-color); font-weight: 500; }
    .ticket-link { color: var(--accent-color); text-decoration: none; font-weight: 500; transition: color 0.2s ease; }
    .ticket-link:hover { color: var(--primary-color); text-decoration: underline; }

    .date-cell { white-space: nowrap; min-width: 120px; }
    .summary-cell { white-space: normal; overflow: visible; max-width: none; word-break: break-word; }

    .search-controls { margin-top: 1rem; display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }
    .search-section { display: flex; align-items: center; gap: 0.5rem; flex: 1; min-width: 300px; }
    .search-label { font-weight: 500; color: var(--primary-color); white-space: nowrap; }
    .filter-section { display: flex; align-items: center; gap: 0.5rem; flex-wrap: nowrap; }
    .filter-btn { padding: 0.5rem 1rem; border: 2px solid #e9ecef; background: white; color: #6c757d; border-radius: var(--border-radius); transition: all 0.2s ease; cursor: pointer; white-space: nowrap; font-size: 0.85rem; }

    .modal-xl { max-width: 95vw; }
    .review-iframe { width: 100%; height: 80vh; border: none; }
</style>

<div class="container-fluid">
    <!-- Statistics Cards -->
    <div class="row stats-row">
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="stat-card running">
                <div class="stat-number">
                    {{ pipeline_data | selectattr('status', 'equalto', 'IN_PROGRESS') | list | length }}
                </div>
                <div class="stat-label">In Progress</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="stat-card success">
                <div class="stat-number">
                    {{ pipeline_data | selectattr('status', 'equalto', 'success') | list | length }}
                </div>
                <div class="stat-label">Success</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="stat-card failed">
                <div class="stat-number">
                    {{ pipeline_data | selectattr('status', 'equalto', 'failed') | list | length }}
                </div>
                <div class="stat-label">Failed</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="stat-card manual">
                <div class="stat-number">
                    {{ pipeline_data | selectattr('status', 'equalto', 'manual') | list | length }}
                </div>
                <div class="stat-label">Approved</div>
            </div>
        </div>
    </div>

    <!-- Pipeline + Draft Table -->
    <div class="table-container">
        <div class="table-header">
            <div class="search-controls">
                <div class="position-relative w-100" style="max-width: 600px;">
                  <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-3 text-muted"></i>
                  <input type="text" class="form-control ps-5 rounded-pill" placeholder="Search" id="searchInput">
                </div>
                <div class="filter-section">
                    <button class="filter-btn active" data-status="all">All</button>
                    <button class="filter-btn" data-status="success">Success</button>
                    <button class="filter-btn" data-status="failed">Failed</button>
                    <button class="filter-btn" data-status="manual">Approved</button>
                    <button class="filter-btn" data-status="in_progress">In Progress</button>
                     <button class="filter-btn" data-status="pending_approval">Pending Approval</button>
                    <button class="filter-btn" data-status="draft">Draft</button>
                </div>
                <div class="timezone-control d-flex align-items-center gap-2 small">
                    <span class="timezone-label fw-bold"><i class="fas fa-globe me-1"></i> Timezone</span>
                    <select class="timezone-select form-select form-select-sm w-auto" id="timezoneSelect">
                        <option value="local">Local time</option>
                        <option value="UTC">UTC</option>
                        <option value="America/New_York">EST (New York)</option>
                        <option value="America/Los_Angeles">PST (Los Angeles)</option>
                        <option value="Europe/London">GMT (London)</option>
                        <option value="Europe/Paris">CET (Paris)</option>
                        <option value="Asia/Tokyo">JST (Tokyo)</option>
                        <option value="Asia/Singapore">SGT (Singapore)</option>
                        <option value="Australia/Sydney">AEDT (Sydney)</option>
                    </select>
                </div>
                <div id="refreshStatus" class="text-muted small my-2 ms-2"></div>
            </div>
        </div>

        <table class="table custom-table" id="pipelinesTable">
            <thead>
                <tr>
                    <th><i class="fas fa-code"></i> Workflow ID</th>
                    <th><i class="fas fa-ticket-alt"></i> Ticket ID</th>
                    <th>Environment</th>
                    <th><i class="fas fa-list"></i> Summary</th>
                    <th><i class="fas fa-info-circle"></i> Status</th>
                    <th><i class="fas fa-calendar-plus"></i> Start</th>
                    <th><i class="fas fa-calendar-check"></i> End</th>
                    <th><i class="fas fa-stopwatch"></i> Duration</th>
                    <th><i class="fas fa-check"></i> Action</th>
                </tr>
            </thead>
            <tbody>
                {% for pipeline in (pipeline_data | sort(attribute='created_at', reverse=True)) %}
                {% set jira_ticket = (jira_tickets | selectattr('workflow_id', 'equalto', pipeline.workflow_id) | list | first) %}
                {% set raw_status = pipeline.status.lower() %}
                {% set normalized_status = raw_status %}

                {# 解析 Environment #}
                {% set summary_txt = (jira_ticket.summary if jira_ticket else '') %}
                {% set env_val = '-' %}
                {% if summary_txt %}
                    {% set parts = summary_txt.split(']') %}
                    {% if parts|length > 1 %}
                        {% set after = parts[1].strip() %}
                        {% set env_val = after.split(' - ')[0].strip() %}
                    {% endif %}
                {% endif %}
                {% set env_upper = env_val.upper() if env_val != '-' else '-' %}

                <tr data-status="{{ normalized_status }}" data-workflow-id="{{ pipeline.workflow_id }}">
                    <td><span class="workflow-id">{{ pipeline.workflow_id }}</span></td>
                    <td>
                        {% if jira_ticket and jira_ticket.ticket_id %}
                            <a href="{{ jira_ticket.url }}" target="_blank" class="ticket-link">{{ jira_ticket.ticket_id }}</a>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>{{ env_upper }}</td>
                    <td class="summary-cell">
                        {{ jira_ticket.summary if jira_ticket else '-' }}
                    </td>
                    <td>
                        <span class="status-badge status-{{ normalized_status }}">{{ pipeline.status }}</span>
                    </td>

                    {# 顯示層去掉 'T'；data-datetime 維持原值 #}
                    <td class="date-cell" data-datetime="{{ pipeline.created_at }}">{{ (pipeline.created_at or '')|replace('T',' ') or '-' }}</td>
                    <td class="date-cell" data-datetime="{{ pipeline.finished_at }}">{{ (pipeline.finished_at or '')|replace('T',' ') or '-' }}</td>

                    <td class="duration-cell" data-seconds="{{ pipeline.duration or 0 }}"></td>
                    <td>
                        <div class="d-flex gap-1">
                          {# Review：所有狀態都顯示；非 DRAFT → readonly=1 #}
                          <a class="btn btn-sm btn-outline-secondary btn-row-review"
                             data-workflow-id="{{ pipeline.workflow_id }}"
                             data-readonly="{{ 1 if normalized_status != 'draft' else 0 }}"
                             title="Review">
                            <i class="bi bi-eye"></i>
                          </a>

                          {% if normalized_status == 'draft' %}
                              <button type="button"
                                      class="btn btn-sm btn-outline-primary btn-draft-edit"
                                      data-action="edit"
                                      data-workflow-id="{{ pipeline.workflow_id }}"
                                      title="Edit">
                                <i class="bi bi-pencil-square"></i>
                              </button>
                              <button type="button"
                                      class="btn btn-sm btn-outline-danger btn-draft-delete"
                                      data-action="delete"
                                      data-workflow-id="{{ pipeline.workflow_id }}"
                                      title="Delete">
                                <i class="bi bi-trash"></i>
                              </button>

                          {% elif normalized_status == 'pending_approval' %}
                            <!-- 待核可：顯示綠色 Approve（用 modal） -->
                            <button type="button"
                                    class="btn btn-sm btn-primary btn-row-approve"
                                    data-workflow-id="{{ pipeline.workflow_id }}"
                                    title="Approve">
                              Approve
                            </button>

                          {% elif normalized_status == 'success' %}
                            <!-- 已核可/完成 -->
                            <button class="btn btn-sm btn-outline-success" disabled>Approved</button>

                          {% else %}
                            <!-- 其他狀態不允許核可 -->
                            <button class="btn btn-sm btn-secondary" disabled>Approve</button>
                          {% endif %}

                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="pagination-controls">
            <div class="entries-control">
                <span>Show</span>
                <select class="entries-select" id="entriesPerPage">
                    <option value="5">5</option>
                    <option value="10" selected>10</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
                <span>entries</span>
            </div>

            <div class="pagination-info" id="paginationInfo">
                Showing 1 to 10 of 0 entries
            </div>

            <div class="pagination-nav" id="paginationNav">
                <button class="pagination-btn" id="firstPage" title="First">&laquo;</button>
                <button class="pagination-btn" id="prevPage" title="Previous">&lsaquo;</button>
                <span id="pageNumbers"></span>
                <button class="pagination-btn" id="nextPage" title="Next">&rsaquo;</button>
                <button class="pagination-btn" id="lastPage" title="Last">&raquo;</button>
            </div>
        </div>
    </div>
</div>

<!-- Review Modal -->
<div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="reviewModalLabel">Review Request</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-0">
        <iframe id="reviewFrame" class="review-iframe"></iframe>
      </div>
      <div class="modal-footer">
        <!-- 不改 review.html，本頁以 JS 隱藏提交鈕 -->
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Approve Modal -->
<div class="modal fade" id="approveModal" tabindex="-1" aria-labelledby="approveModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="approveModalLabel">Approve Pipeline</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-0">
        <iframe id="approveFrame" class="review-iframe"></iframe>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


<script>
/* ========================================================================
 * Router URL templates
 * ====================================================================== */
const REVIEW_URL_TMPL = "{{ url_for('vm.workflow_review_page', workflow_id=0) }}";
const APPROVE_URL_TMPL = "{{ url_for('vm.workflow_approve_page', workflow_id=0) }}";
const EDIT_URL_TMPL   = "{{ url_for('vm.workflow_draft_edit',  workflow_id=0) }}";
const DELETE_URL_TMPL = "{{ url_for('vm.workflow_draft_delete',workflow_id=0) }}";

/* ========================================================================
 * TimezoneManager：維持原邏輯；顯示上移除 'T'
 * ====================================================================== */
class TimezoneManager {
  constructor() {
    this.currentTimezone = 'local';
    this.timezoneSelect  = document.getElementById('timezoneSelect');
    this._bindEvents();
    this._detectUserTimezoneLabel();
    this.updateAllDateCells();
  }
  _bindEvents() {
    if (!this.timezoneSelect) return;
    this.timezoneSelect.addEventListener('change', (e) => {
      this.currentTimezone = e.target.value;
      this.updateAllDateCells();
    });
  }
  _detectUserTimezoneLabel() {
    try {
      const userTz = Intl.DateTimeFormat().resolvedOptions().timeZone;
      const localOption = this.timezoneSelect?.querySelector('option[value="local"]');
      if (localOption) localOption.textContent = `Local time (${userTz})`;
    } catch (e) { console.warn(e); }
  }
  _formatDateTime(datetimeStr, timezone) {
    if (!datetimeStr || datetimeStr === '-' || datetimeStr === 'None') return '-';
    try {
      const date = new Date(datetimeStr);
      if (isNaN(date.getTime())) return (datetimeStr || '').replace('T',' ');
      const opts = {
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit', second: '2-digit',
        hour12: false
      };
      if (timezone !== 'local') opts.timeZone = timezone;
      return date.toLocaleString('en-CA', opts).replace(',', '');
    } catch (e) {
      return (datetimeStr || '').replace('T',' ');
    }
  }
  updateAllDateCells() {
    document.querySelectorAll('.date-cell[data-datetime]').forEach(cell => {
      const raw = cell.getAttribute('data-datetime');
      cell.textContent = this._formatDateTime(raw, this.currentTimezone);
    });
  }
}

/* ========================================================================
 * TablePagination：只調整 Review 事件為單一路徑
 * ====================================================================== */
class TablePagination {
  constructor() {
    this.currentPage     = 1;
    this.entriesPerPage  = 10;
    this.currentFilter   = 'all';
    this.tableBody       = document.querySelector('#pipelinesTable tbody');
    this.allRows         = Array.from(this.tableBody?.querySelectorAll('tr') || []);
    this.filteredRows    = [...this.allRows];

    this.searchInput     = document.getElementById('searchInput');
    this.entriesSelect   = document.getElementById('entriesPerPage');
    this.paginationInfo  = document.getElementById('paginationInfo');
    this.pageNumbers     = document.getElementById('pageNumbers');
    this.firstPageBtn    = document.getElementById('firstPage');
    this.prevPageBtn     = document.getElementById('prevPage');
    this.nextPageBtn     = document.getElementById('nextPage');
    this.lastPageBtn     = document.getElementById('lastPage');
    this.filterButtons   = document.querySelectorAll('.filter-btn');

    this._bindEvents();
    this.applyFilters();
    this.updateDisplay();
    this._startAutoRefresh();
  }

  _bindEvents() {
    if (this.searchInput) {
      this.searchInput.addEventListener('input', () => {
        this.applyFilters(); this.currentPage = 1; this.updateDisplay();
      });
    }
    if (this.entriesSelect) {
      this.entriesSelect.addEventListener('change', (e) => {
        this.entriesPerPage = parseInt(e.target.value, 10);
        this.currentPage = 1; this.updateDisplay();
      });
    }
    this.filterButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        this.filterButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        this.currentFilter = btn.dataset.status;
        this.applyFilters(); this.currentPage = 1; this.updateDisplay();
      });
    });

    document.addEventListener('click', async (e) => {
      const reviewBtn = e.target.closest('.btn-row-review');
      const approveBtn = e.target.closest('.btn-row-approve');
      const editBtn   = e.target.closest('.btn-draft-edit');
      const deleteBtn = e.target.closest('.btn-draft-delete');

      if (reviewBtn) {
        const wfId = reviewBtn.getAttribute('data-workflow-id');
        const readonly = reviewBtn.getAttribute('data-readonly') === '1';
        openReviewModal(wfId, readonly);
        return;
      }

      if (editBtn) {
        const wfId = editBtn.getAttribute('data-workflow-id');
        window.location.href = EDIT_URL_TMPL.replace('0', wfId);
        return;
      }

     if (approveBtn) {
       const pid = approveBtn.getAttribute('data-workflow-id');
       openApproveModal(pid);
       return;
     }

      if (deleteBtn) {
        const wfId = deleteBtn.getAttribute('data-workflow-id');
        if (!confirm(`Delete Draft #${wfId}?`)) return;
        try {
          const resp = await fetch(DELETE_URL_TMPL.replace('0', wfId), {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
          });
          if (!resp.ok) {
            const txt = await resp.text();
            alert('Delete failed: ' + txt);
            return;
          }
          const row = e.target.closest('tr');
          if (row) row.remove();
          this._reindexRows();
        } catch (err) {
          console.error(err);
          alert('Network error while deleting draft.');
        }
        return;
      }
    });

    this.firstPageBtn?.addEventListener('click', () => this.goToPage(1));
    this.prevPageBtn?.addEventListener('click',  () => this.goToPage(this.currentPage - 1));
    this.nextPageBtn?.addEventListener('click',  () => this.goToPage(this.currentPage + 1));
    this.lastPageBtn?.addEventListener('click',  () => this.goToPage(this.getTotalPages()));
  }

  applyFilters() {
    const term = (this.searchInput?.value || '').toLowerCase();
    this.filteredRows = this.allRows.filter(row => {
      if (this.currentFilter !== 'all' && row.dataset.status !== this.currentFilter) return false;
      if (!term) return true;
      return Array.from(row.cells).some(td => td.textContent.toLowerCase().includes(term));
    });
  }

  updateDisplay() {
    const totalEntries = this.filteredRows.length;
    const totalPages   = this.getTotalPages();

    if (this.currentPage > totalPages) this.currentPage = totalPages || 1;
    const start = (this.currentPage - 1) * this.entriesPerPage;
    const end   = start + this.entriesPerPage;

    this.allRows.forEach(row => row.style.display = 'none');
    this.filteredRows.slice(start, end).forEach(row => row.style.display = '');

    const showingStart = totalEntries === 0 ? 0 : start + 1;
    const showingEnd   = Math.min(end, totalEntries);
    if (this.paginationInfo) this.paginationInfo.textContent = `Showing ${showingStart} to ${showingEnd} of ${totalEntries} entries`;

    const atFirst = this.currentPage === 1;
    const atLast  = this.currentPage === totalPages || totalPages === 0;
    if (this.firstPageBtn) this.firstPageBtn.disabled = atFirst;
    if (this.prevPageBtn)  this.prevPageBtn.disabled  = atFirst;
    if (this.nextPageBtn)  this.nextPageBtn.disabled  = atLast;
    if (this.lastPageBtn)  this.lastPageBtn.disabled  = atLast;

    this._renderPageNumbers(totalPages);
    this._updateDurationCells();
  }

  _startAutoRefresh() {
    const intervalMs  = 3000;
    const refreshHint = document.getElementById('refreshStatus');

    setInterval(() => {
      if (refreshHint) {
        const now = new Date().toLocaleTimeString();
        refreshHint.textContent = `Refreshing data every ${intervalMs / 1000} seconds... (${now})`;
      }
      this._refreshData();
    }, intervalMs);
  }

  _refreshData() {
    fetch(window.location.href)
      .then(res => res.text())
      .then(html => {
        const doc = new DOMParser().parseFromString(html, 'text/html');
        const newTbody = doc.querySelector('#pipelinesTable tbody');
        if (!newTbody || !this.tableBody) return;

        this.tableBody.innerHTML = newTbody.innerHTML;
        this._reindexRows();

        if (window.timezoneManager) window.timezoneManager.updateAllDateCells();
      })
      .catch(err => console.error('刷新資料失敗:', err));
  }

  _reindexRows() {
    this.allRows = Array.from(this.tableBody.querySelectorAll('tr'));
    this.applyFilters();
    this.updateDisplay();
  }

  getTotalPages() { return Math.ceil(this.filteredRows.length / this.entriesPerPage); }
  goToPage(page) {
    const totalPages = this.getTotalPages();
    const p = Math.max(1, Math.min(page, totalPages || 1));
    if (p === this.currentPage) return;
    this.currentPage = p;
    this.updateDisplay();
  }
  _renderPageNumbers(totalPages) {
    if (!this.pageNumbers) return;
    this.pageNumbers.innerHTML = '';
    const max = 7;
    let start = Math.max(this.currentPage - Math.floor(max / 2), 1);
    let end   = start + max - 1;
    if (end > totalPages) {
      end = totalPages;
      start = Math.max(end - max + 1, 1);
    }
    for (let i = start; i <= end; i++) {
      const btn = document.createElement('button');
      btn.textContent = i;
      btn.classList.add('pagination-btn');
      if (i === this.currentPage) { btn.classList.add('active'); btn.disabled = true; }
      btn.addEventListener('click', () => this.goToPage(i));
      this.pageNumbers.appendChild(btn);
    }
  }
  _updateDurationCells() {
    document.querySelectorAll('.duration-cell').forEach(cell => {
      const seconds = parseInt(cell.dataset.seconds, 10);
      if (isNaN(seconds) || seconds <= 0) {
        cell.textContent = '-';
      } else {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        cell.textContent = `${mins > 0 ? `${mins}m` : ''}${secs}s`;
      }
    });
  }
}

/* ========================================================================
 * Review Modal helper：readonly 時隱藏 iframe 內 submit
 * ====================================================================== */
function openReviewModal(workflowId, readonly=false) {
  const src = REVIEW_URL_TMPL.replace('0', workflowId) + (readonly ? '?readonly=1' : '');
  const frame = document.getElementById('reviewFrame');
  if (!frame) return;

  frame.onload = () => {
    try {
      if (!readonly) return;
      const doc = frame.contentDocument || frame.contentWindow?.document;
      if (!doc) return;
      const submitElList = doc.querySelectorAll('button[type="submit"], input[type="submit"], .btn-submit, .js-submit');
      submitElList.forEach(el => {
        el.style.display = 'none';
        el.disabled = true;
      });
    } catch (e) {
      console.warn('Cannot hide submit button inside iframe:', e);
    }
  };

  frame.src = src;
  const modal = new bootstrap.Modal(document.getElementById('reviewModal'));
  modal.show();
}


/* ========================================================================
 * Approve Modal helper
 * ====================================================================== */
function openApproveModal(workflowId) {
  const frame = document.getElementById('approveFrame');
  if (!frame) return;
  const src = APPROVE_URL_TMPL.replace('0', workflowId) + "?from_modal=1"; // 建議帶參數給後端

  frame.src = src;

  const modalEl = document.getElementById('approveModal');
  const modal = new bootstrap.Modal(modalEl);

  // 關閉後刷新（若後端已核可完成，按鈕會變 Approved）
  modalEl.addEventListener('hidden.bs.modal', () => {
    try { window.tablePagination?._refreshData(); } catch(e) { console.warn(e); }
  }, { once: true });

  modal.show();
}

/* ========================================================================
 * 入口
 * ====================================================================== */
document.addEventListener('DOMContentLoaded', () => {
  const timezoneManager = new TimezoneManager();
  const tablePagination = new TablePagination();
  window.timezoneManager = timezoneManager;
  window.tablePagination = tablePagination;
});
</script>

{% endblock %}